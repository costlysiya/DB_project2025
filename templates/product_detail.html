{% extends "base.html" %}

<!-- product.nameì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ë³¸ê°’ ì¶”ê°€ -->
{% block title %}ìƒí’ˆ ìƒì„¸ | {{ product.name | default('ìƒí’ˆ ì—†ìŒ', true) }} | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}

    <!-- ìƒí’ˆ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° 404 ë©”ì‹œì§€ í‘œì‹œ -->
    {% if not product or not listing %}
        <h2>ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (404)</h2>
        <p>ìš”ì²­í•˜ì‹  ìƒí’ˆ(Listing ID: {{ listing_id }})ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <a href="/">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    {% else %}
    <!-- ìƒí’ˆ ì •ë³´ê°€ ìˆì„ ê²½ìš° ìƒì„¸ í˜ì´ì§€ í‘œì‹œ -->
    <div class="product-detail-container">

        <div class="image-gallery">
            <!-- Productì˜ ëŒ€í‘œ ì´ë¯¸ì§€(image_url)ë¥¼ ë©”ì¸ ì´ë¯¸ì§€ë¡œ ì‚¬ìš© -->
            <img src="{{ product.image_url | default('https://placehold.co/600x600/eee/ccc?text=No+Image', true) }}" alt="{{ product.name }}" class="main-image">

            <!--
            2ì°¨ íŒë§¤ìì˜ ì‹¤ë¬¼ ì‚¬ì§„ (ListingImage)ì´ ìˆìœ¼ë©´ ì¸ë„¤ì¼ë¡œ í‘œì‹œ
            1ì°¨ íŒë§¤ì(Primary)ëŠ” ì´ ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŒ
            -->
            {% if resale_images %}
            <div class="thumbnail-list">
                <!--  ì¸ë„¤ì¼ í´ë¦­ ì‹œ ë©”ì¸ ì´ë¯¸ì§€ ë³€ê²½ JS ì¶”ê°€ -->
                {% for img in resale_images %}
                <img src="{{ img.image_url }}" alt="ì‹¤ë¬¼ ì‚¬ì§„ ì¸ë„¤ì¼" onclick="document.querySelector('.main-image').src='{{ img.image_url }}'">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="product-info-box">
            <p class="category-path">í™ˆ > {{ product.category }}</p>
            <h1>{{ product.name }}</h1>
            <p class="description">{{ product.description | default('ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.', true) }}</p>

            <hr>

            <div class="price-section">
                <span class="label">
                    {% if listing.listing_type == 'Resale' and listing.status in ['ê²½ë§¤ ì¤‘', 'ê²½ë§¤ ì˜ˆì •'] %}
                        í˜„ì¬ ê²½ë§¤ê°€
                    {% else %}
                        íŒë§¤ ê°€ê²©
                    {% endif %}
                </span>
                <span class="price-value">{{ "{:,.0f}ì›".format(listing.price) }}</span>
            </div>

            <div class="seller-section">
                <span class="label">íŒë§¤ì</span>
                <span class="seller-name">
                    {{ seller.store_name if seller.store_name else seller.seller_name }}
                </span>
                <span class="seller-grade">ë“±ê¸‰: {{ seller.seller_grade | default('N/A', true) }} </span>
            </div>

            <div class="detail-section">
                <p><strong>íŒë§¤ í˜•íƒœ:</strong> <span class="listing-type-value">{{ '1ì°¨ íŒë§¤' if listing.listing_type == 'Primary' else '2ì°¨ íŒë§¤ (Resale)' }}</span></p>
                {% if listing.condition %}
                <p><strong>ìƒí’ˆ ìƒíƒœ:</strong> <span>{{ listing.condition }}</span></p>
                {% endif %}
                <p><strong>ë‚¨ì€ ì¬ê³ :</strong> <span class="stock-value">{{ listing.stock }}ê°œ</span></p>
            </div>

            <hr>

            <!-- ì¬ê³ ê°€ ì—†ê±°ë‚˜ ê²½ë§¤ ì¤‘ì¼ ë•Œ êµ¬ë§¤ í¼ ë¹„í™œì„±í™” -->
            {% if listing.stock == 0 or listing.status == 'í’ˆì ˆ' %}
                <div class="purchase-form" style="background-color: #f5f5f5;">
                    <h3 style="text-align: center; color: #dc3545;">ğŸš« í’ˆì ˆëœ ìƒí’ˆì…ë‹ˆë‹¤.</h3>
                </div>
            {% elif listing.status in ['ê²½ë§¤ ì¤‘', 'ê²½ë§¤ ì˜ˆì •'] %}
                 <div class="purchase-form" style="background-color: #fcf8e3;">
                    <h3 style="text-align: center; color: #f57f17;">ğŸ”¥ ê²½ë§¤ê°€ ì§„í–‰ ì¤‘ì¸ ìƒí’ˆì…ë‹ˆë‹¤.</h3>
                    <p style="text-align: center;">ì…ì°°ì„ í†µí•´ ì°¸ì—¬í•´ì£¼ì„¸ìš”.</p>
                    <!-- ì…ì°° ë²„íŠ¼ (idëŠ” auction_idê°€ í•„ìš”í•¨ -> ì¶”ê°€ ì¿¼ë¦¬ í•„ìš”) -->
                    <button type="button" class="btn secondary-btn" style="width: 100%;" onclick="alert('ì…ì°° ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”')">ì…ì°°í•˜ê¸°</button>
                 </div>
            {% else %}
            <!--  ì¬ê³ ê°€ ìˆì„ ë•Œë§Œ êµ¬ë§¤ í¼ í™œì„±í™” -->
            <form id="cart-form" class="purchase-form">
                <input type="hidden" name="listing_id" value="{{ listing.listing_id }}">

                <div class="quantity-selector">
                    <label for="quantity">êµ¬ë§¤ ìˆ˜ëŸ‰</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ listing.stock }}" required onchange="updateTotalPrice()">
                </div>

                <div class="total-price">
                    ì´ ê²°ì œ ê¸ˆì•¡:
                    <span id="final-price">{{ "{:,.0f}ì›".format(listing.price) }}</span>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn primary-btn cart-btn">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                    <button type="button" class="btn secondary-btn buy-btn" onclick="alert('ë°”ë¡œ êµ¬ë§¤ ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”')">ë°”ë¡œ êµ¬ë§¤</button>
                </div>
                <!-- AJAX ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
                <div id="cart-message" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
            </form>
            {% endif %}

        </div>
    </div>

    <script>
        // ìˆ˜ëŸ‰ ë³€ê²½ ì‹œ ì´ ê²°ì œ ê¸ˆì•¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        // listing.priceê°€ 0ì´ê±°ë‚˜ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„
        const basePrice = {{ listing.price | default(0) }};
        const stock = {{ listing.stock | default(0) }};
        const quantityInput = document.getElementById('quantity');
        const finalPriceEl = document.getElementById('final-price');

        function updateTotalPrice() {
            // quantityInputì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ (í’ˆì ˆ/ê²½ë§¤ ì‹œ)
            if (!quantityInput) return;

            //ìˆ˜ëŸ‰ 1ì´ìƒ ì¬ê³  ì´í•˜ë¡œ ë§ì¶°ì¤Œ
            let quantity = parseInt(quantityInput.value, 10);

            if (isNaN(quantity) || quantity < 1) {
                quantity = 1;
                quantityInput.value = 1;
            }
            if (quantity > stock) {
                quantity = stock;
                quantityInput.value = stock;
            }

            const totalPrice = basePrice * quantity;
            //  JSì—ì„œ ì‰¼í‘œ í¬ë§·íŒ… (toLocalString)
            finalPriceEl.textContent = totalPrice.toLocaleString('ko-KR') + 'ì›';
        }

        //  ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° AJAX
        const cartForm = document.getElementById('cart-form');
        const cartMessage = document.getElementById('cart-message');

        if (cartForm) {
            cartForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ(ìƒˆë¡œê³ ì¹¨) ë°©ì§€

                const data = {
                    listing_id: {{ listing.listing_id }},
                    quantity: parseInt(quantityInput.value, 10)
                };

                cartMessage.textContent = 'ì²˜ë¦¬ ì¤‘...';
                cartMessage.style.color = 'gray';

                try {
                    // '/api/cart/add' API í˜¸ì¶œ
                    const response = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        cartMessage.textContent = result.message;
                        cartMessage.style.color = '#ff69b4'; // style.css í•‘í¬ìƒ‰
                    } else {
                        cartMessage.textContent = `ì˜¤ë¥˜: ${result.error || result.message}`;
                        cartMessage.style.color = '#dc3545'; // style.css ë¹¨ê°„ìƒ‰
                    }

                } catch (error) {
                    cartMessage.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    cartMessage.style.color = '#dc3545';
                }
            });
        }
    </script>

    <style>
        /*  ì¸ë„¤ì¼ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì»¤ì„œ ë³€ê²½ ë° ìŠ¤íƒ€ì¼ ì¡°ì • */
        .thumbnail-list img {
            width: 80px;
            height: 80px;
            object-fit: cover; /*  ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ */
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.2s;
        }
        .thumbnail-list img:hover {
            border-color: #ff69b4; /* style.css í•‘í¬ìƒ‰ */
        }
    </style>
    {% endif %} <!--  if not product ... else ... end -->

{% endblock %}