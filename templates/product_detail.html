{% extends "base.html" %}

<!-- product.nameì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ë³¸ê°’ ì¶”ê°€ -->
{% block title %}ìƒí’ˆ ìƒì„¸ | {{ product.name | default('ìƒí’ˆ ì—†ìŒ', true) }} | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}

    <!-- ìƒí’ˆ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° 404 ë©”ì‹œì§€ í‘œì‹œ -->
    {% if not product or not listing %}
        <h2>ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (404)</h2>
        <p>ìš”ì²­í•˜ì‹  ìƒí’ˆ(Listing ID: {{ listing_id }})ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <a href="/">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    {% else %}
    <!-- ìƒí’ˆ ì •ë³´ê°€ ìˆì„ ê²½ìš° ìƒì„¸ í˜ì´ì§€ í‘œì‹œ -->
    <div class="product-detail-container">

        <div class="image-gallery">
            <!-- Productì˜ ëŒ€í‘œ ì´ë¯¸ì§€(image_url)ë¥¼ ë©”ì¸ ì´ë¯¸ì§€ë¡œ ì‚¬ìš© -->
            <img src="{{ product.image_url | default('https://placehold.co/600x600/eee/ccc?text=No+Image', true) }}" alt="{{ product.name }}" class="main-image">

            <!--
            2ì°¨ íŒë§¤ìì˜ ì‹¤ë¬¼ ì‚¬ì§„ (ListingImage)ì´ ìˆìœ¼ë©´ ì¸ë„¤ì¼ë¡œ í‘œì‹œ
            1ì°¨ íŒë§¤ì(Primary)ëŠ” ì´ ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŒ
            -->
            {% if resale_images %}
            <div class="thumbnail-list">
                <!--  ì¸ë„¤ì¼ í´ë¦­ ì‹œ ë©”ì¸ ì´ë¯¸ì§€ ë³€ê²½ JS ì¶”ê°€ -->
                {% for img in resale_images %}
                <img src="{{ img.image_url }}" alt="ì‹¤ë¬¼ ì‚¬ì§„ ì¸ë„¤ì¼" onclick="document.querySelector('.main-image').src='{{ img.image_url }}'">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="product-info-box">
            <p class="category-path">í™ˆ > {{ product.category }}</p>
            <h1>{{ product.name }}</h1>
            <p class="description">{{ product.description | default('ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.', true) }}</p>

            <hr>

            <div class="price-section">
                <span class="label">
                    {% if listing.listing_type == 'Resale' and listing.status in ['ê²½ë§¤ ì¤‘', 'ê²½ë§¤ ì˜ˆì •'] %}
                        í˜„ì¬ ê²½ë§¤ê°€
                    {% else %}
                        íŒë§¤ ê°€ê²©
                    {% endif %}
                </span>
                <span class="price-value">{{ "{:,.0f}ì›".format(listing.price) }}</span>
            </div>

            <div class="seller-section">
                <span class="label">íŒë§¤ì</span>
                <span class="seller-name">
                    {{ seller.store_name if seller.store_name else seller.seller_name }}
                </span>
                <span class="seller-grade">ë“±ê¸‰: {{ seller.seller_grade | default('N/A', true) }} </span>
            </div>

            <div class="detail-section">
                <p><strong>íŒë§¤ í˜•íƒœ:</strong> <span class="listing-type-value">{{ '1ì°¨ íŒë§¤' if listing.listing_type == 'Primary' else '2ì°¨ íŒë§¤ (Resale)' }}</span></p>
                {% if listing.condition %}
                <p><strong>ìƒí’ˆ ìƒíƒœ:</strong> <span>{{ listing.condition }}</span></p>
                {% endif %}
                <p><strong>ë‚¨ì€ ì¬ê³ :</strong> <span class="stock-value">{{ listing.stock }}ê°œ</span></p>
            </div>

            <hr>

            <!-- ì¬ê³ ê°€ ì—†ê±°ë‚˜ ê²½ë§¤ ì¤‘ì¼ ë•Œ êµ¬ë§¤ í¼ ë¹„í™œì„±í™” -->
            {% if listing.stock == 0 or listing.status == 'í’ˆì ˆ' %}
                <div class="purchase-form" style="background-color: #f5f5f5;">
                    <h3 style="text-align: center; color: #dc3545;">ğŸš« í’ˆì ˆëœ ìƒí’ˆì…ë‹ˆë‹¤.</h3>
                </div>
            {% elif listing.status in ['ê²½ë§¤ ì¤‘', 'ê²½ë§¤ ì˜ˆì •'] or is_auction_ended %}

                <div class="auction-box">

                    <h3 class="auction-status-title">
                        {% if is_auction_ended %}
                            âœ… ê²½ë§¤ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
                        {% elif listing.status == 'ê²½ë§¤ ì¤‘' %}
                            ğŸ”¥ ê²½ë§¤ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.
                        {% else %}
                            â³ ê²½ë§¤ ì‹œì‘ ì˜ˆì •ì…ë‹ˆë‹¤.
                        {% endif %}
                    </h3>

                    <div class="auction-details-info">
                        <p><strong>ì‹œì‘ ì‹œê°„:</strong> <span>{{ auction.start_date | datetime_format }}</span></p>
                        <p><strong>ë§ˆê° ì‹œê°„:</strong> <span id="auction-end-time">{{ auction.end_date | datetime_format }}</span></p>
                    </div>

                    <div class="current-bid-section">
                        <span class="label">í˜„ì¬ ìµœê³  ì…ì°°ê°€</span>
                        <span class="price-value">{{ "{:,.0f}ì›".format(auction.current_price) }}</span>
                        {% if auction.current_highest_bidder_id %}
                            <p class="bidder-info">ìµœê³  ì…ì°°ì: {{ auction.highest_bidder_name | default('ìµëª…', true) }}</p>
                        {% else %}
                            <p class="bidder-info">ì•„ì§ ì…ì°°ìê°€ ì—†ìŠµë‹ˆë‹¤. (ì‹œì‘ê°€: {{ "{:,.0f}ì›".format(auction.start_price) }})</p>
                        {% endif %}
                    </div>

                    {% if is_auction_ended %}
                        <div class="purchase-form" style="background-color: #e6f7ff; padding: 15px; border: 1px solid #cceeff;">
                            <h3 style="text-align: center; color: #3498db; margin-bottom: 10px;">ğŸ† ê²½ë§¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</h3>
                            {% if auction.current_highest_bidder_id %}
                                <p style="text-align: center; font-weight: bold; font-size: 1.1em;">ìµœì¢… ë‚™ì°°ê°€: {{ "{:,.0f}ì›".format(auction.current_price) }}</p>
                            {% else %}
                                <p style="text-align: center; color: #777; font-weight: bold;">ìœ ì°°ë˜ì—ˆìŠµë‹ˆë‹¤ (ì…ì°°ì ì—†ìŒ).</p>
                            {% endif %}
                        </div>

                    {% elif listing.status == 'ê²½ë§¤ ì¤‘' and session.user_role == 'Buyer' %}
                        <form id="bid-form" class="bid-form">
                            <input type="hidden" name="auction_id" value="{{ auction.auction_id }}">

                            <div class="bid-input-group">
                                <label for="my_bid">ë‚´ê°€ ì œì‹œí•  ì…ì°°ê°€</label>
                                <input type="number"
                                        id="my_bid"
                                        name="bid_price"
                                        min="{{ auction.current_price + 1000 }}"
                                        placeholder="{{ (auction.current_price + 1000) | number_format }}ì› ì´ìƒ"
                                        required>
                            </div>

                            <button type="submit" class="btn primary-btn bid-btn">ì…ì°°í•˜ê¸°</button>
                             <div id="bid-message" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
                        </form>

                    {% elif listing.status == 'ê²½ë§¤ ì¤‘' and session.user_role != 'Buyer' %}
                        <p style="text-align: center; font-weight: bold; color: #dc3545;">êµ¬ë§¤ìë§Œ ì…ì°°ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    {% endif %}

                 </div>
            {% else %}
            <!--  ì¬ê³ ê°€ ìˆì„ ë•Œë§Œ êµ¬ë§¤ í¼ í™œì„±í™” -->
            <form id="cart-form" class="purchase-form">
                <input type="hidden" name="listing_id" value="{{ listing.listing_id }}">

                <div class="quantity-selector">
                    <label for="quantity">êµ¬ë§¤ ìˆ˜ëŸ‰</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ listing.stock }}" required onchange="updateTotalPrice()">
                </div>

                <div class="total-price">
                    ì´ ê²°ì œ ê¸ˆì•¡:
                    <span id="final-price">{{ "{:,.0f}ì›".format(listing.price) }}</span>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn primary-btn cart-btn">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                    <button type="button" class="btn secondary-btn buy-btn" id="buy-now-btn">ë°”ë¡œ êµ¬ë§¤</button>
                </div>
                <!-- AJAX ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
                <div id="cart-message" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
            </form>
            {% endif %}

        </div>
    </div>

   <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. ê³µí†µ ë³€ìˆ˜ ---
            const basePrice = {{ listing.price | default(0) }};
            const stock = {{ listing.stock | default(0) }};
            const quantityInput = document.getElementById('quantity');
            const finalPriceEl = document.getElementById('final-price');
            const cartMessage = document.getElementById('cart-message');

            // --- 2. ê°€ê²© ê³„ì‚° í•¨ìˆ˜ ---
            function updateTotalPrice() {
                if (!quantityInput) return;

                let quantity = parseInt(quantityInput.value, 10);

                if (isNaN(quantity) || quantity < 1) {
                    quantity = 1;
                    quantityInput.value = 1;
                }
                if (quantity > stock) {
                    quantity = stock;
                    quantityInput.value = stock;
                }

                const totalPrice = basePrice * quantity;
                finalPriceEl.textContent = totalPrice.toLocaleString('ko-KR') + 'ì›';
            }

            // --- 3. ê²½ë§¤ ì…ì°° ë¡œì§ ---
            const bidForm = document.getElementById('bid-form');
            if (bidForm) {
                const bidMessage = document.getElementById('bid-message');
                const currentPriceSpan = document.querySelector('.current-bid-section .price-value');
                const bidPriceInput = document.getElementById('my_bid');

                bidForm.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    if (!{{ session.user_id }}) {
                        alert("ì…ì°°ì„ ìœ„í•´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    const data = {
                        auction_id: parseInt(bidForm.auction_id.value),
                        bid_price: parseInt(bidPriceInput.value, 10)
                    };

                    bidMessage.textContent = 'ì…ì°° ì²˜ë¦¬ ì¤‘...';
                    bidMessage.style.color = 'gray';

                    try {
                        const response = await fetch('/api/auction/bid', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            bidMessage.textContent = result.message || "ì…ì°° ì„±ê³µ!";
                            bidMessage.style.color = '#ff69b4';

                            const newPrice = result.new_price;
                            currentPriceSpan.textContent = newPrice.toLocaleString('ko-KR') + 'ì›';

                            bidPriceInput.min = newPrice + 1000;
                            bidPriceInput.placeholder = (newPrice + 1000).toLocaleString('ko-KR') + 'ì› ì´ìƒ';

                        } else {
                            bidMessage.textContent = `âŒ ì˜¤ë¥˜: ${result.error || result.message}`;
                            bidMessage.style.color = '#dc3545';
                        }

                    } catch (error) {
                        bidMessage.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                        bidMessage.style.color = '#dc3545';
                    }
                });
            }


            // --- 4. ì¼ë°˜ íŒë§¤ ë¡œì§ (ì¥ë°”êµ¬ë‹ˆ / ë°”ë¡œ êµ¬ë§¤) ---
            const cartForm = document.getElementById('cart-form');

            if (cartForm) {

                // 4-1. ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° (Submit ì´ë²¤íŠ¸)
                cartForm.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    const data = {
                        listing_id: {{ listing.listing_id }},
                        quantity: parseInt(quantityInput.value, 10)
                    };

                    if (!{{ session.user_id }}) {
                        alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ìœ¼ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    cartMessage.textContent = 'ì¥ë°”êµ¬ë‹ˆ ì²˜ë¦¬ ì¤‘...';
                    cartMessage.style.color = 'gray';

                    try {
                        const response = await fetch('/api/cart/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            cartMessage.textContent = result.message;
                            cartMessage.style.color = '#ff69b4';
                        } else {
                            cartMessage.textContent = `âŒ ì˜¤ë¥˜: ${result.error || result.message}`;
                            cartMessage.style.color = '#dc3545';
                        }

                    } catch (error) {
                        cartMessage.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                        cartMessage.style.color = '#dc3545';
                    }
                });

                // 4-2. ë°”ë¡œ êµ¬ë§¤ (Click ì´ë²¤íŠ¸)
                const buyNowBtn = document.getElementById('buy-now-btn');
                buyNowBtn.addEventListener('click', async function() {

                    const quantity = parseInt(quantityInput.value, 10);

                    if (!{{ session.user_id }}) {
                        alert("ì£¼ë¬¸ì„ ìœ„í•´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    if (!quantity || quantity <= 0) {
                        alert("êµ¬ë§¤ ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    if (!confirm(`${quantityInput.value}ê°œ ìƒí’ˆì„ ë°”ë¡œ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }

                    const itemsToOrder = [{
                        listing_id: {{ listing.listing_id }},
                        quantity: quantity
                        // cart_idëŠ” ë°”ë¡œ êµ¬ë§¤ ì‹œ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ìƒëµ
                    }];

                    cartMessage.textContent = 'ì£¼ë¬¸ ê²€ì¦ ë° ì²˜ë¦¬ ì¤‘...';
                    cartMessage.style.color = '#ff69b4';

                    try {
                        // ì¥ë°”êµ¬ë‹ˆ ì£¼ë¬¸ API ì¬ì‚¬ìš©
                        const response = await fetch('/api/order/place', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ items: itemsToOrder })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert(result.message);
                            // ì£¼ë¬¸ ì„±ê³µ ì‹œ ë§ˆì´í˜ì´ì§€ ì£¼ë¬¸ ë‚´ì—­ìœ¼ë¡œ ì´ë™
                            window.location.href = '{{ url_for("show_mypage", view="orders") }}';
                        } else {
                            alert(`ì£¼ë¬¸ ì‹¤íŒ¨: ${result.error || result.message}`);
                            cartMessage.textContent = `âŒ ì£¼ë¬¸ ì‹¤íŒ¨: ${result.error || result.message}`;
                            cartMessage.style.color = '#dc3545';
                        }

                    } catch (error) {
                        cartMessage.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        cartMessage.style.color = '#dc3545';
                    }
                });
            }
        });
    </script>


    <style>
        /* ì¸ë„¤ì¼ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì»¤ì„œ ë³€ê²½ ë° ìŠ¤íƒ€ì¼ ì¡°ì • */
        .thumbnail-list img {
            width: 80px;
            height: 80px;
            object-fit: cover; /* ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ */
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.2s;
        }
        .thumbnail-list img:hover {
            border-color: #ff69b4; /* style.css í•‘í¬ìƒ‰ */
        }

        .auction-box {
            padding: 20px;
            background-color: #fcf8e3;
            border: 1px solid #faebcc;
            border-radius: 8px;
            margin-top: 20px;
        }
        .auction-status-title {
            text-align: center;
            font-size: 1.3em;
            color: #f57f17;
            margin-bottom: 15px;
        }
        .auction-details-info p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
        }
        .current-bid-section {
            text-align: center;
            margin: 20px 0;
            padding: 15px 0;
            border-top: 1px dashed #f0e6c3;
            border-bottom: 1px dashed #f0e6c3;
        }
        .current-bid-section .label {
            display: block;
            font-size: 0.9em;
            color: #777;
        }
        .current-bid-section .price-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #dc3545;
        }
        .bidder-info {
            font-size: 0.85em;
            color: #333;
            margin-top: 5px;
        }
        .bid-input-group {
            text-align: left;
            margin-bottom: 15px;
        }
        .bid-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .bid-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .bid-btn {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            background-color: #ff69b4;
            color: white;
        }

    </style>
    {% endif %} <!--  if not product ... else ... end -->

{% endblock %}