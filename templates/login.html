{% extends "base.html" %}

{% block title %}로그인 | SELECT MARKET{% endblock %}

{% block content %}
    <div class="form-container">
        <h2>사용자 로그인</h2>

        <!-- form 태그 수정: action과 method를 제거하고 id를 부여하여 JS가 제어하도록 함 -->
        <form id="loginForm">

            <div class="form-group">
                <label for="username">아이디 (User ID)</label>
                <!-- name 속성 수정: user_uid로 Flask 코드와 일치 -->
                <input type="text" id="username" name="user_uid" placeholder="아이디를 입력하세요" required>
            </div>

            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요" required>
            </div>

            <!-- 메시지 표시 공간 추가 -->
            <p id="message-area" style="color: red; margin-top: 10px; font-weight: bold;"></p>

            <button type="submit" class="btn full-width">로그인</button>
        </form>

        <p class="signup-link">
            계정이 없으신가요?
            <a href="/signup">회원가입</a>
        </p>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginForm');
            const messageArea = document.getElementById('message-area');

            form.addEventListener('submit', function(event) {
                event.preventDefault(); // 기본 폼 제출 방지

                messageArea.textContent = '로그인 시도 중...';
                messageArea.style.color = 'gray';

                const loginData = {
                    user_uid: document.querySelector('input[name="user_uid"]').value,
                    password: document.querySelector('input[name="password"]').value
                };

                // Flask API (POST /api/login) 호출
                fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                })
                .then(response => {
                    return response.json().then(data => {
                        if (!response.ok) {
                            // 401, 500 등 오류일 때 메시지를 추출하여 Promise.reject로 전달
                            const errorMsg = data.message || data.error || "알 수 없는 오류 (API 응답 실패)";
                            return Promise.reject(new Error(errorMsg));
                        }
                        return data; // 200 OK 시 성공 데이터 반환
                    });
                })
                .then(data => {
                    // 로그인 성공 처리 (200 OK)
                    const successMsg = data.message + " (" + data.user_role + ")";
                    messageArea.textContent = successMsg;
                    messageArea.style.color = 'green';

                    alert("로그인 성공: " + successMsg);

                    // TODO: 성공 후 메인 페이지 또는 역할별 대시보드로 이동
                    window.location.href = '/products';
                })
                .catch(error => {
                    // 로그인 실패 처리 (401 Unauthorized 등)
                    const displayMsg = error.message;
                    messageArea.textContent = "로그인 실패: " + displayMsg;
                    messageArea.style.color = 'red';

                    alert("로그인 실패: " + displayMsg); // alert 팝업 표시
                });
            });
        });
    </script>
{% endblock %}