{% extends "base.html" %}

{% block title %}ë©”ì¸ | SELECT MARKET ë² ìŠ¤íŠ¸ êµ¿ì¦ˆ{% endblock %}

{% block content %}

    <div class="product-list-header">
        <!-- ìƒí’ˆ ê°œìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ í‘œì‹œ -->
        <span class="product-count">{{ page_title | default('ì „ì²´ ìƒí’ˆ') }}: {{ product_count }}ê°œ</span>

        <div class="sorting-options">
            <select name="sort_by" id="sort-select">
                <option value="latest" {% if sort_by == 'latest' %}selected{% endif %}>ìµœì‹  ë“±ë¡ìˆœ</option>
                <option value="low_price" {% if sort_by == 'low_price' %}selected{% endif %}>ë‚®ì€ ê°€ê²©ìˆœ</option>
                <option value="high_price" {% if sort_by == 'high_price' %}selected{% endif %}>ë†’ì€ ê°€ê²©ìˆœ</option>
                {% if session.user_role == 'PrimarySeller' %}
                <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>êµ¿ì¦ˆ ë“±ê¸‰ìˆœ (Rating)</option>
                {% endif %}
            </select>
        </div>
    </div>

    <!-- ìƒí’ˆ ê·¸ë¦¬ë“œë¥¼ for ë£¨í”„ë¡œ ë™ì  ìƒì„± -->
    <div class="product-grid">

        <!-- products ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆì„ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ -->
        {% if not products %}
            <div style="text-align: center; grid-column: 1 / -1; padding: 40px;">
                <p>í‘œì‹œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        {% endif %}

        <!-- products ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©° ìƒí’ˆ ì¹´ë“œ ìƒì„± -->
        {% for product in products %}

        <!-- ìƒíƒœë³„ë¡œ í´ë˜ìŠ¤ ë¶„ê¸° -->
        <div class="product-card
            {% if product.listing_status == 'í’ˆì ˆ' or product.listing_status == 'íŒë§¤ ì¢…ë£Œ' %}sold-out{% endif %}
            {% if product.listing_status in ['ê²½ë§¤ ì¤‘', 'ê²½ë§¤ ì˜ˆì •'] %}auction{% endif %}
        ">

            <!-- ë§í¬ì™€ ì´ë¯¸ì§€ ë™ì  ì„¤ì • -->
            <a href="{{ url_for('show_product_detail', listing_id=product.listing_id) }}">
                <div class="card-image"
                     style="background-image: url('{{ product.image_url | default('https://placehold.co/600x400/eee/ccc?text=No+Image', true) }}');">

                    <!-- 1ì°¨/2ì°¨ íŒë§¤ ë°°ì§€ ë™ì  ì„¤ì • -->
                    {% if product.listing_type == 'Resale' %}
                        <span class="badge resale">Resale</span>
                    {% else %}
                        <span class="badge primary">Primary</span>
                    {% endif %}
                </div>
            </a>

            <div class="card-info">
                <!-- ì¹´í…Œê³ ë¦¬ -->
                <p class="category">{{ product.category }}</p>
                <!-- ìƒí’ˆëª… -->
                <h4 class="product-name">
                    <a href="{{ url_for('show_product_detail', listing_id=product.listing_id) }}">{{ product.product_name }}</a>

                    {% if session.user_role in ['PrimarySeller', 'Administrator'] and product.product_rating %}
                        <span style="font-size: 0.9em; color: #ff69b4;">({{ product.product_rating }} ë“±ê¸‰)</span>
                    {% endif %}
                </h4>
                <!-- íŒë§¤ì ì •ë³´ -->
                <p class="seller-info">{{ product.seller_name }} ({{ product.seller_grade | default('N/A', true) }})</p>
                <!-- ê°€ê²© (ê²½ë§¤/ì¼ë°˜ íŒë§¤ ë¶„ê¸°) -->
                {% if product.listing_status in ['ê²½ë§¤ ì¤‘', 'ê²½ë§¤ ì˜ˆì •'] %}
                    <p class="product-price auction-price">í˜„ì¬ê°€: {{ "{:,.0f}ì›".format(product.current_price or product.price) }}</p>
                {% else %}
                    <p class="product-price">{{ "{:,.0f}ì›".format(product.price) }}</p>
                {% endif %}

                <!-- ìƒíƒœ í‘œì‹œ (í’ˆì ˆ > ê²½ë§¤ > ë¦¬ì…€ìƒíƒœ > ë“±ê¸‰ ìˆœìœ¼ë¡œ í‘œì‹œ) -->
                {% if product.listing_status == 'íŒë§¤ ì¢…ë£Œ' %}
                <span class="status-tag" style="color: gray;">âœ… ê²½ë§¤ ì™„ë£Œ</span>
                {% elif product.listing_status == 'ê²½ë§¤ ì¤‘' %}
                    <span class="status-tag">ğŸ”¥ ê²½ë§¤ ì¤‘</span>
                {% elif product.listing_status == 'í’ˆì ˆ' %}
                    <span class="status-tag">ğŸš« í’ˆì ˆ</span>
                {% elif product.listing_status == 'ê²½ë§¤ ì˜ˆì •' %}
                    <span class="status-tag">â³ ê²½ë§¤ ì˜ˆì •</span>
                {% elif product.listing_type == 'Resale' and product.condition %}
                    <span class="product-condition">ìƒíƒœ: {{ product.condition }}</span>
                {% elif product.product_rating %}
                    <span class="product-rating">ë“±ê¸‰: {{ product.product_rating }}</span>
                {% endif %}

            </div>
        </div>
        {% endfor %} <!-- for ë£¨í”„ ë -->

    </div>
<script>
    document.getElementById('sort-select').addEventListener('change', function() {
        const sortBy = this.value;

        // 1. í˜„ì¬ URLì˜ Pathì™€ Query Stringì„ ê°€ì ¸ì˜´
        // ì˜ˆ: /category/ìŒë°˜?search=í¬ì¹´
        const currentPath = window.location.pathname;
        const currentSearchParams = new URLSearchParams(window.location.search);

        // 2. ê¸°ì¡´ íŒŒë¼ë¯¸í„°(category, search ë“±)ë¥¼ ìœ ì§€í•˜ë©´ì„œ sort_byë§Œ ë³€ê²½/ì¶”ê°€
        currentSearchParams.set('sort_by', sortBy);

        // 3. í˜ì´ì§€ ì´ë™ (Path + ì—…ë°ì´íŠ¸ëœ Query String)
        window.location.href = currentPath + '?' + currentSearchParams.toString();
    });
</script>
{% endblock %}
