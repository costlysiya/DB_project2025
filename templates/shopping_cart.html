{% extends "base.html" %}

{% block title %}ì¥ë°”êµ¬ë‹ˆ | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}
    
    <h2>ğŸ›’ ë‚˜ì˜ ì¥ë°”êµ¬ë‹ˆ ({{ cart_items | length }}ê°œ ìƒí’ˆ)</h2>

    <div class="cart-content">

        <!-- ì¥ë°”êµ¬ë‹ˆ ìˆ˜ëŸ‰ ë³€ê²½ ë° ì‚­ì œëŠ” AJAXë¡œ ì²˜ë¦¬í•  ì˜ˆì •ì´ë¯€ë¡œ í¼ ì•¡ì…˜ ë³€ê²½ -->
        <form id="cart-update-form">
            <table class="cart-table">
                <thead>
                    <tr>
                        <th class="col-check"><input type="checkbox" id="check_all"></th>
                        <th class="col-product">ìƒí’ˆ ì •ë³´</th>
                        <th class="col-price">ê°€ê²©</th>
                        <th class="col-qty">ìˆ˜ëŸ‰</th>
                        <th class="col-total">ì£¼ë¬¸ ê¸ˆì•¡</th>
                        <th class="col-delete">ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ì¥ë°”êµ¬ë‹ˆ í•­ëª© ë™ì  ë£¨í”„ -->
                    {% if cart_items %}
                        {% for item in cart_items %}
                        <tr data-cart-id="{{ item.cart_id }}">
                            <td class="col-check"><input type="checkbox" name="selected_items" value="{{ item.cart_id }}" checked></td>
                            <td class="col-product">
                                <div class="product-info-cart">
                                    <img src="{{ item.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ item.product_name }}">

                                    <div>
                                        <a href="/product/{{ item.listing_id }}">{{ item.product_name }}</a>
                                        <span class="badge {{ 'resale' if item.listing_type == 'Resale' else 'primary' }}">{{ item.listing_type }}</span>
                                    </div>
                                </div>
                            </td>
                            <!-- ê°€ê²© í¬ë§·íŒ… -->
                            <td class="col-price">{{ "{:,.0f}ì›".format(item.price) }}</td>
                            <td class="col-qty">
                                <!-- ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ ë™ì  ìƒì„± ë° ìµœëŒ€ ì¬ê³  ë°˜ì˜ -->
                                <input type="number"
                                       name="quantity_{{ item.cart_id }}"
                                       value="{{ item.quantity }}"
                                       min="1"
                                       max="{{ item.max_stock }}"
                                       class="qty-input"
                                       data-cart-id="{{ item.cart_id }}"
                                       data-unit-price="{{ item.price }}">
                            </td>
                            <!-- í•­ëª©ë³„ ì´ ê¸ˆì•¡ -->
                            <td class="col-total item-total">{{ "{:,.0f}ì›".format(item.item_total) }}</td>
                            <td class="col-delete">
                                <button type="button" class="btn-delete" data-cart-id="{{ item.cart_id }}">âœ–</button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" style="padding: 30px; color: #777; font-weight: bold;">ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>

<!--            <div class="cart-actions">-->
<!--                &lt;!&ndash; ìˆ˜ëŸ‰ ë³€ê²½ ë²„íŠ¼ í™œì„±í™” &ndash;&gt;-->
<!--&lt;!&ndash;                <button type="button" id="update-cart-btn" class="btn secondary-btn">ì„ íƒ ìƒí’ˆ ìˆ˜ëŸ‰ ë³€ê²½</button>&ndash;&gt;-->
<!--&lt;!&ndash;                <button type="button" id="delete-selected-btn" class="btn secondary-btn" style="background-color: #dc3545; margin-left: 10px;">ì„ íƒ ìƒí’ˆ ì‚­ì œ</button>&ndash;&gt;-->
<!--            </div>-->
        </form>
    </div>

    <div class="cart-summary">
        <h3>ê²°ì œ ì˜ˆì • ê¸ˆì•¡</h3>
        <div class="summary-line">
            <span>ì´ ìƒí’ˆ ê¸ˆì•¡</span>
            <span class="summary-value" id="summary-goods-total">{{ "{:,.0f}ì›".format(total_price) }}</span>
        </div>
        <div class="summary-line">
            <span>ë°°ì†¡ë¹„</span>
            <span class="summary-value" id="summary-shipping">{{ "{:,.0f}ì›".format(shipping_fee) }}</span>
        </div>
        <div class="summary-line total">
            <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
            <span class="summary-value final-total" id="summary-final-total">{{ "{:,.0f}ì›".format(final_total) }}</span>
        </div>

        <button type="button" class="btn primary-btn order-btn" id="order-selected-btn">ì„ íƒ ìƒí’ˆ ì£¼ë¬¸í•˜ê¸° (Order)</button>
    </div>

    <!-- AJAX ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
    <div id="api-message" style="text-align: center; margin-top: 15px; font-weight: bold;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkAll = document.getElementById('check_all');
            const itemChecks = document.querySelectorAll('input[name="selected_items"]');
            const qtyInputs = document.querySelectorAll('.qty-input');
<!--            const deleteSelectedBtn = document.getElementById('delete-selected-btn');-->
<!--            const updateCartBtn = document.getElementById('update-cart-btn');-->
            const rowDeleteBtns = document.querySelectorAll('.btn-delete');
            const orderBtn = document.getElementById('order-selected-btn');
            const messageArea = document.getElementById('api-message');

            // ì´ì•¡ ìš”ì†Œ
            const goodsTotalEl = document.getElementById('summary-goods-total');
            const shippingEl = document.getElementById('summary-shipping');
            const finalTotalEl = document.getElementById('summary-final-total');


            //ìš”ì•½ ê¸ˆì•¡ì„ ê³„ì‚°í•˜ê³  í™”ë©´ì— ì—…ë°ì´íŠ¸í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
            function recalculateSummary() {
                let currentGoodsTotal = 0;

                // 1. ì²´í¬ëœ í•­ëª©ë§Œ ê¸ˆì•¡ì„ í•©ì‚°
                document.querySelectorAll('tr[data-cart-id]').forEach(row => {
                    const cartId = row.getAttribute('data-cart-id');
                    const checkbox = row.querySelector(`input[name="selected_items"][value="${cartId}"]`);
                    const qtyInput = row.querySelector('.qty-input');

                    if (checkbox && checkbox.checked && qtyInput) {
                        const qty = parseInt(qtyInput.value, 10);
                        const unitPrice = parseFloat(qtyInput.getAttribute('data-unit-price'));
                        const itemTotal = qty * unitPrice;

                        currentGoodsTotal += itemTotal;

                        // í™”ë©´ì˜ í•­ëª©ë³„ ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°˜ì˜)
                        row.querySelector('.item-total').textContent = itemTotal.toLocaleString('ko-KR') + 'ì›';
                    }
                });

                // 2. ë°°ì†¡ë¹„ ê³„ì‚° (5ë§Œì› ì´ìƒ ë¬´ë£Œ)
                let calculatedShippingFee = 3000;
                if (currentGoodsTotal >= 50000 || currentGoodsTotal === 0) {
                    calculatedShippingFee = 0;
                }

                const finalTotal = currentGoodsTotal + calculatedShippingFee;

                // 3. í™”ë©´ ì—…ë°ì´íŠ¸
                goodsTotalEl.textContent = currentGoodsTotal.toLocaleString('ko-KR') + 'ì›';
                shippingEl.textContent = calculatedShippingFee > 0 ? `+ ${calculatedShippingFee.toLocaleString('ko-KR')}ì›` : '0ì› (ë¬´ë£Œ)';
                finalTotalEl.textContent = finalTotal.toLocaleString('ko-KR') + 'ì›';
            }

            // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ ---

            // ì „ì²´ ì„ íƒ/í•´ì œ & ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ
            checkAll.addEventListener('change', function() {
                itemChecks.forEach(checkbox => checkbox.checked = checkAll.checked);
                recalculateSummary();
            });
            itemChecks.forEach(checkbox => checkbox.addEventListener('change', recalculateSummary));

            // ìˆ˜ëŸ‰ ì…ë ¥ ë³€ê²½ ì‹œ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë° ìœ íš¨ì„± ê²€ì‚¬)
            qtyInputs.forEach(input => {
                input.addEventListener('input', function() {
                    let qty = parseInt(this.value, 10);
                    const maxStock = parseInt(this.max, 10);

                    if (isNaN(qty) || qty < 1) {
                        qty = 1;
                        this.value = 1;
                    }
                    if (qty > maxStock) {
                        alert(`ìµœëŒ€ ì¬ê³ ëŠ” ${maxStock}ê°œ ì…ë‹ˆë‹¤.`);
                        qty = maxStock;
                        this.value = maxStock;
                    }
                    recalculateSummary();
                });
            });

<!--            //  ì„ íƒ í•­ëª© ì‚­ì œ ê¸°ëŠ¥ ì—°ê²° -->
<!--            deleteSelectedBtn.addEventListener('click', async function() {-->
<!--                const selectedCartIds = Array.from(itemChecks)-->
<!--                                        .filter(cb => cb.checked)-->
<!--                                        .map(cb => parseInt(cb.value));-->

<!--                if (selectedCartIds.length === 0) {-->
<!--                    alert('ì‚­ì œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');-->
<!--                    return;-->
<!--                }-->
<!--                if (!confirm(`ì„ íƒí•œ ìƒí’ˆ ${selectedCartIds.length}ê°œë¥¼ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {-->
<!--                    return;-->
<!--                }-->

<!--                messageArea.textContent = 'ì„ íƒ í•­ëª© ì‚­ì œ ìš”ì²­ ì¤‘...';-->
<!--                messageArea.style.color = 'gray';-->

<!--                try {-->
<!--                    const response = await fetch('/api/cart/remove', {-->
<!--                        method: 'POST',-->
<!--                        headers: { 'Content-Type': 'application/json' },-->
<!--                        body: JSON.stringify({ cart_ids: selectedCartIds })-->
<!--                    });-->

<!--                    const result = await response.json();-->

<!--                    if (response.ok) {-->
<!--                        alert(result.message);-->
<!--                        window.location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ UI ì™„ë²½ ë°˜ì˜-->
<!--                    } else {-->
<!--                        alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.error || result.message}`);-->
<!--                        messageArea.textContent = `ì‚­ì œ ì‹¤íŒ¨: ${result.error || result.message}`;-->
<!--                        messageArea.style.color = '#dc3545';-->
<!--                    }-->

<!--                } catch (error) {-->
<!--                    messageArea.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';-->
<!--                    messageArea.style.color = '#dc3545';-->
<!--                }-->
<!--            });-->

            // (ê°œë³„ ì‚­ì œ ë²„íŠ¼ ì—°ê²°)
            rowDeleteBtns.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const cartId = parseInt(this.getAttribute('data-cart-id'));

                    if (!confirm('ì´ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                    try {
                        const response = await fetch('/api/cart/remove', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cart_ids: [cartId] })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert(result.message);
                            window.location.reload();
                        } else {
                            alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.error || result.message}`);
                        }
                    } catch (error) {
                        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });

            //  ì£¼ë¬¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì¬ê³  ê²€ì¦ ë¡œì§ ì—°ê²°
            orderBtn.addEventListener('click', async function() {
                const selectedItems = [];
                const itemRows = document.querySelectorAll('tr[data-cart-id]');

                itemRows.forEach(row => {
                    const cartId = row.getAttribute('data-cart-id');
                    const checkbox = row.querySelector(`input[name="selected_items"][value="${cartId}"]`);
                    const qtyInput = row.querySelector('.qty-input');
                    const listingId = row.querySelector('a').getAttribute('href').split('/').pop();

                    if (checkbox && checkbox.checked) {
                        // ì„ íƒëœ í•­ëª©ì˜ í˜„ì¬ ìˆ˜ëŸ‰ê³¼ listing ID ìˆ˜ì§‘
                        selectedItems.push({
                            cart_id: parseInt(cartId, 10), // ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•  ë•Œ í•„ìš”
                            listing_id: parseInt(listingId, 10),
                            quantity: parseInt(qtyInput.value, 10)
                        });
                    }
                });

                if (selectedItems.length === 0) {
                    alert('ì£¼ë¬¸í•  ìƒí’ˆì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                messageArea.textContent = 'ì¬ê³  ë° ì£¼ë¬¸ ì •ë³´ ê²€ì¦ ì¤‘...';
                messageArea.style.color = 'gray';

                try {
                    //ì¬ê³  ê²€ì¦ ë° ì£¼ë¬¸ íŠ¸ëœì­ì…˜
                    const response = await fetch('/api/order/place', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: selectedItems })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message);
                        messageArea.textContent = result.message;
                        messageArea.style.color = '#ff69b4';
                        // ì£¼ë¬¸ ì„±ê³µ ì‹œ ë§ˆì´í˜ì´ì§€/ì£¼ë¬¸ ë‚´ì—­ìœ¼ë¡œ ì´ë™
                        window.location.href = '/mypage';
                    } else {
                        // ì¬ê³  ë¶€ì¡±ì´ë‚˜ íŒë§¤ ìƒíƒœ ì˜¤ë¥˜ ì‹œ ê²½ê³ 
                        alert(result.error || result.message);
                        messageArea.textContent = `ì£¼ë¬¸ ì‹¤íŒ¨: ${result.error || result.message}`;
                        messageArea.style.color = '#dc3545';
                        // ì‹¤íŒ¨ ì‹œ ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ë³€ê²½ë  ìˆ˜ ìˆëŠ” ì¬ê³ /ìƒíƒœ ë°˜ì˜)
                        setTimeout(() => window.location.reload(), 1500);
                    }

                } catch (error) {
                    console.error('Order API error:', error);
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    messageArea.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    messageArea.style.color = '#dc3545';
                }
            });


            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœì´ˆ 1íšŒ ìš”ì•½ ê¸ˆì•¡ ê³„ì‚°
            recalculateSummary();
        });
    </script>
{% endblock %}