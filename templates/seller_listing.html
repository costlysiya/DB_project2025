{% extends "base.html" %}

{% block title %}ìƒí’ˆ ë“±ë¡ | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}

    <h2>ğŸ›ï¸ ì‹ ê·œ êµ¿ì¦ˆ ë“±ë¡í•˜ê¸°</h2>
    <p class="subtitle">1ì°¨ íŒë§¤ìëŠ” ê³µì‹ êµ¿ì¦ˆë¥¼, 2ì°¨ íŒë§¤ìëŠ” ë¦¬ì…€ êµ¿ì¦ˆë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="form-container wide">

        <!-- (â˜…) í¼ ì œì¶œ ë¡œì§ì´ AJAX(ìë°”ìŠ¤í¬ë¦½íŠ¸) ë°©ì‹ì´ë¯€ë¡œ formì˜ action/methodëŠ” ì œê±°í•©ë‹ˆë‹¤. -->
        <form id="product-register-form">

            <!--
                (â˜…) seller_id, listing_typeì€ ì„¸ì…˜ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ
                HTMLì— ìˆ¨ê²¨ë‘˜ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. (app.pyì—ì„œ ì´ë¯¸ ì²˜ë¦¬ ì¤‘)
            -->

            <div class="form-group-section">
                <h3>1. êµ¿ì¦ˆ ë§ˆìŠ¤í„° ì •ë³´ (Product)</h3>
                <div class="form-group">
                    <label for="product_name">êµ¿ì¦ˆ ì´ë¦„ <span class="required">*</span></label>
                    {% if session.user_role == 'Reseller' %}
                        <select id="product_name" name="product_name" required>
                            <option value="">-- ê¸°ì¡´ ìƒí’ˆëª… ì„ íƒ (í•„ìˆ˜) --</option>
                            {% for name in product_names %}
                                <option value="{{ name }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <input type="text" id="product_name" name="product_name" required placeholder="ìƒˆë¡œìš´ ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.">
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="category">ì¹´í…Œê³ ë¦¬ <span class="required">*</span></label>
                    <select id="category" name="category" required>
                        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        <option value="ìŒë°˜">ğŸ’¿ ìŒë°˜</option>
                        <option value="í”¼ê·œì–´">ğŸ¤– í”¼ê·œì–´</option>
                        <option value="ì¸í˜•">ğŸ§¸ ì¸í˜•</option>
                        <option value="ì•„í¬ë¦´">âœ¨ ì•„í¬ë¦´</option>
                        <option value="ì‘ì›ë„êµ¬">ğŸ“£ ì‘ì›ë„êµ¬</option>
                        <option value="í¬ì¹´">ğŸ–¼ï¸ í¬ì¹´</option>
                        <option value="ì˜ë¥˜">ğŸ‘š ì˜ë¥˜</option>
                        <option value="ê¸°íƒ€">ğŸ ê¸°íƒ€</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">ìƒì„¸ ì„¤ëª…</label>
                    <textarea id="description" name="description" rows="5" placeholder="ìƒí’ˆì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                </div>

                {% if session.user_role == 'PrimarySeller' %}
                <div class="form-group">
                    <label for="master_image_url">ë§ˆìŠ¤í„° ì´ë¯¸ì§€ URL</label>
                    <input type="url" id="master_image_url" name="master_image_url" placeholder="ìƒí’ˆ ëŒ€í‘œ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”.">
                </div>
                {% endif %}
            </div>

            <hr>

            <div class="form-group-section">
                <h3>2. íŒë§¤ ìƒì„¸ ì •ë³´ (Listing)</h3>

                <div class="form-group">
                    <label for="price">íŒë§¤ ê°€ê²© <span class="required">*</span></label>
                    <input type="number" id="price" name="price" required min="0" max="9999999" placeholder="ìµœëŒ€ 9,999,999ì›">
                </div>

                <div class="form-group">
                    <label for="stock">ì¬ê³  ìˆ˜ëŸ‰ <span class="required">*</span></label>
                    <input type="number" id="stock" name="stock" required min="0" placeholder="0 ì´ìƒì˜ ì¬ê³  ìˆ˜ëŸ‰">
                </div>

                <!--
                (â˜…ìˆ˜ì •)
                Resellerì¼ ê²½ìš°ì—ë§Œ 2ì°¨ íŒë§¤ í•„ë“œì™€ ê²½ë§¤ í•„ë“œ ì„¹ì…˜ì´ ë Œë”ë§ë©ë‹ˆë‹¤.
                -->
                {% if session.user_role == 'Reseller' %}
                <div id="reseller-fields">
                    <div class="form-group">
                        <label for="condition">ìƒí’ˆ ìƒíƒœ <span class="required">*</span></label>
                        <select id="condition" name="condition" required>
                            <option value="">-- ìƒí’ˆ ìƒíƒœ ì„ íƒ (í•„ìˆ˜) --</option>
                            <option value="ë¯¸ê°œë´‰">ë¯¸ê°œë´‰ (S)</option>
                            <option value="ìµœìƒ">ìµœìƒ (A)</option>
                            <option value="ì¤‘">ì¤‘ (B)</option>
                            <option value="í•˜">í•˜ (C)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="resale_images">ì‹¤ë¬¼ ì´ë¯¸ì§€ URL ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="file" id="resale_images" name="resale_images" multiple accept="image/*"
                               {% if session.user_role == 'Reseller' %} required {% endif %}>
                        <p class="note">âš ï¸ 2ì°¨ íŒë§¤ìëŠ” ì‹¤ë¬¼ ì‚¬ì§„ URLì„ ì…ë ¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
                    </div>

                    <div class="form-group auction-toggle">
                        <label>ê²½ë§¤ ë“±ë¡ ì—¬ë¶€</label>
                        <input type="checkbox" id="is_auction" name="is_auction" value="true">
                        <label for="is_auction" style="display: inline-block;">ì´ ìƒí’ˆì„ ê²½ë§¤ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.</label>
                    </div>
                </div>

                <!-- (â˜…ìˆ˜ì •) ê²½ë§¤ ìƒì„¸ ì •ë³´ divë¥¼ Reseller IF ë¸”ë¡ ì•ˆìœ¼ë¡œ ì´ë™ -->
                <div id="auction-details" class="hidden">
                    <h3>3. ê²½ë§¤ ìƒì„¸ ì •ë³´ (Auction)</h3>
                    <div class="form-group">
                        <label for="auction_start_price">ê²½ë§¤ ì‹œì‘ ê°€ê²© <span class="required">*</span></label>
                        <input type="number" id="auction_start_price" name="auction_start_price" placeholder="ê²½ë§¤ ì‹œì‘ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
                    </div>
                    <div class="form-group">
                        <label for="auction_start_date">ê²½ë§¤ ì‹œì‘ ì‹œê°„ <span class="required">*</span></label>
                        <input type="datetime-local" id="auction_start_date" name="auction_start_date">
                    </div>
                    <div class="form-group">
                        <label for="auction_end_date">ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ <span class="required">*</span></label>
                        <input type="datetime-local" id="auction_end_date" name="auction_end_date">
                    </div>
                </div>
                {% endif %} <!-- (â˜…ìˆ˜ì •) Reseller IF ë¸”ë¡ì„ ì—¬ê¸°ì„œ ë‹«ìŠµë‹ˆë‹¤. -->

            </div>

            <button type="submit" class="btn full-width submit-btn">ìƒí’ˆ ë“±ë¡ ì™„ë£Œ</button>

            <!-- (â˜…ì‹ ê·œ) AJAX ì‘ë‹µ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  div -->
            <div id="api-message" class="api-message" style="margin-top: 15px;"></div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isAuctionCheckbox = document.getElementById('is_auction');
            const auctionDetailsDiv = document.getElementById('auction-details');
            // ì¬ê³  í•„ë“œ ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const stockInput = document.getElementById('stock');

            // isAuctionCheckboxê°€ Resellerê°€ ì•„ë‹ˆë©´ nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²´í¬
            if (isAuctionCheckbox) {

                // ê²½ë§¤ ìƒì„¸ í•„ë“œì—ì„œ ì œì–´í•  í•­ëª©ë“¤ì„ ì°¾ìŠµë‹ˆë‹¤.
                const requiredAuctionInputs = auctionDetailsDiv.querySelectorAll('input, select');

                // âš ï¸ ê²½ë§¤ ì‹œì‘ ê°€ê²© í•„ë“œëŠ” HTMLì—ì„œ ìˆ¨ê¹€ ì²˜ë¦¬í•˜ê±°ë‚˜, ì—¬ê¸°ì„œ í•­ìƒ hidden ì²˜ë¦¬í•©ë‹ˆë‹¤.
                const startPriceInput = document.getElementById('auction_start_price');
                if (startPriceInput) {
                    startPriceInput.closest('.form-group').classList.add('hidden'); // HTMLì—ì„œ ìˆ¨ê¸°ê¸°
                }


                function toggleAuctionFields() {
                    const isChecked = isAuctionCheckbox.checked;

                    // ê²½ë§¤ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ í•„ë“œ (auctionDetailsDiv)ë§Œ ë³´ì´ê±°ë‚˜ ìˆ¨ê¹ë‹ˆë‹¤.
                    if (isChecked) {
                        stockInput.value = 1;
                        stockInput.min = 1;
                        stockInput.max = 1; // 1 ì´ìƒ ì…ë ¥ ë¶ˆê°€
                        stockInput.readOnly = true; // ì‚¬ìš©ì ì…ë ¥ ë°©ì§€ (ì„ íƒ ì‚¬í•­)
                        auctionDetailsDiv.classList.remove('hidden');

                        // ê²½ë§¤ ì‹œì‘ ë° ì¢…ë£Œ ì‹œê°„ í•„ë“œì— required ì†ì„± ì¶”ê°€
                        // startPriceInputì€ ì´ë¯¸ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë¯€ë¡œ ì œì™¸í•˜ê³  requiredë¥¼ ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
                        auctionDetailsDiv.querySelectorAll('input[type="datetime-local"]').forEach(input => {
                            input.setAttribute('required', 'required');
                        });

                        // ì¼ë°˜ íŒë§¤ í•„ë“œ (ê°€ê²©, ì¬ê³  ë“±)ëŠ” í•­ìƒ ë³´ì…ë‹ˆë‹¤ (ë³€ê²½ ì—†ìŒ).

                    } else {
                        // ì¼ë°˜ íŒë§¤ ëª¨ë“œ:
                        // 1. ì¬ê³  ì œí•œì„ í’€ê³  ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                        stockInput.min = 0;
                        stockInput.max = 9999999;
                        stockInput.readOnly = false;

                        if (stockInput.value === '1') {
                             stockInput.value = ''; // ê°’ì„ ë¹„ì›Œ ì‚¬ìš©ìì—ê²Œ ì…ë ¥ ìš”êµ¬
                             stockInput.removeAttribute('placeholder');
                        }
                        auctionDetailsDiv.classList.add('hidden');

                        // ê²½ë§¤ í•„ë“œì˜ required ì†ì„± ì œê±°
                        requiredAuctionInputs.forEach(input => input.removeAttribute('required'));
                    }
                }

                isAuctionCheckbox.addEventListener('change', toggleAuctionFields);
                // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰
                toggleAuctionFields();
            }

            // --- 2. AJAX í¼ ì œì¶œ ë¡œì§ (ìœ ì§€) ---
            const form = document.getElementById('product-register-form');
            const messageDiv = document.getElementById('api-message');

            if (form) {
                 form.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    const formData = new FormData(form);
                    // const data = {};
                    if (!formData.has('is_auction')) {
                        formData.append('is_auction', 'false');
                    }

                    if (formData.get('is_auction') === 'true') {
                         if (!formData.get('auction_start_price')) {
                             formData.set('auction_start_price', formData.get('price'));
                         }
                    }

                    if (messageDiv) {
                        messageDiv.textContent = 'ë“±ë¡ ì¤‘...';
                        messageDiv.style.color = 'gray';
                    }


                    try {
                        // âš ï¸ [ê°€ì¥ ì¤‘ìš”] í—¤ë”ì—ì„œ 'Content-Type': 'application/json'ì„ ì œê±°í•˜ê³ ,
                        // FormData ê°ì²´ ìì²´ë¥¼ bodyì— ë„£ì–´ ì „ì†¡í•©ë‹ˆë‹¤.
                        const response = await fetch('/api/product_register', {
                            method: 'POST',
                            body: formData // FormData ê°ì²´ ì§ì ‘ ì „ì†¡
                        });

                        const result = await response.json();

                        if (response.ok) {
                            if (messageDiv) {
                                messageDiv.textContent = `${result.message} (Listing ID: ${result.listing_id})`;
                                messageDiv.style.color = '#ff69b4';
                            } else {
                                alert(result.message);
                            }
                            form.reset();

                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);

                        } else {
                            const errorMessage = `ë“±ë¡ ì‹¤íŒ¨: ${result.error || result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                             if (messageDiv) {
                                messageDiv.textContent = errorMessage;
                                messageDiv.style.color = '#dc3545';
                            } else {
                                alert(errorMessage);
                            }
                        }

                    } catch (error) {
                        console.error('Fetch error:', error);
                        if (messageDiv) {
                            messageDiv.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                            messageDiv.style.color = '#dc3545';
                        } else {
                            alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}
