{% extends "base.html" %}

{% block title %}ìƒí’ˆ ë“±ë¡ | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}
    
    <h2>ğŸ›ï¸ ì‹ ê·œ êµ¿ì¦ˆ ë“±ë¡í•˜ê¸°</h2>
    <p class="subtitle">1ì°¨ íŒë§¤ìëŠ” ê³µì‹ êµ¿ì¦ˆë¥¼, 2ì°¨ íŒë§¤ìëŠ” ë¦¬ì…€ êµ¿ì¦ˆë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    
    <div class="form-container wide">
        
        <!-- (â˜…) í¼ ì œì¶œ ë¡œì§ì´ AJAX(ìë°”ìŠ¤í¬ë¦½íŠ¸) ë°©ì‹ì´ë¯€ë¡œ formì˜ action/methodëŠ” ì œê±°í•©ë‹ˆë‹¤. -->
        <form id="product-register-form">

            <!--
                (â˜…) seller_id, listing_typeì€ ì„¸ì…˜ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ
                HTMLì— ìˆ¨ê²¨ë‘˜ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. (app.pyì—ì„œ ì´ë¯¸ ì²˜ë¦¬ ì¤‘)
            -->

            <div class="form-group-section">
                <h3>1. êµ¿ì¦ˆ ë§ˆìŠ¤í„° ì •ë³´ (Product)</h3>
                <div class="form-group">
                    <label for="product_name">êµ¿ì¦ˆ ì´ë¦„ <span class="required">*</span></label>
                    <input type="text" id="product_name" name="product_name" required placeholder="ì˜ˆ: ì•„ì´ëŒ ì •ê·œ ì•¨ë²” 1ì§‘">
                </div>

                <div class="form-group">
                    <label for="category">ì¹´í…Œê³ ë¦¬ <span class="required">*</span></label>
                    <select id="category" name="category" required>
                        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        <option value="ìŒë°˜">ğŸ’¿ ìŒë°˜</option>
                        <option value="í”¼ê·œì–´">ğŸ¤– í”¼ê·œì–´</option>
                        <option value="ì¸í˜•">ğŸ§¸ ì¸í˜•</option>
                        <option value="ì•„í¬ë¦´">âœ¨ ì•„í¬ë¦´</option>
                        <option value="ì‘ì›ë„êµ¬">ğŸ“£ ì‘ì›ë„êµ¬</option>
                        <option value="í¬ì¹´">ğŸ–¼ï¸ í¬ì¹´</option>
                        <option value="ì˜ë¥˜">ğŸ‘š ì˜ë¥˜</option>
                        <option value="ê¸°íƒ€">ğŸ ê¸°íƒ€</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">ìƒì„¸ ì„¤ëª…</label>
                    <textarea id="description" name="description" rows="5" placeholder="ìƒí’ˆì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                </div>

                {% if session.user_role == 'PrimarySeller' %}
                <div class="form-group">
                    <label for="master_image_url">ë§ˆìŠ¤í„° ì´ë¯¸ì§€ URL</label>
                    <input type="url" id="master_image_url" name="master_image_url" placeholder="ìƒí’ˆ ëŒ€í‘œ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”.">
                </div>
                {% endif %}
            </div>

            <hr>

            <div class="form-group-section">
                <h3>2. íŒë§¤ ìƒì„¸ ì •ë³´ (Listing)</h3>

                <div class="form-group">
                    <label for="price">íŒë§¤ ê°€ê²© <span class="required">*</span></label>
                    <input type="number" id="price" name="price" required min="0" max="9999999" placeholder="ìµœëŒ€ 9,999,999ì›">
                </div>

                <div class="form-group">
                    <label for="stock">ì¬ê³  ìˆ˜ëŸ‰ <span class="required">*</span></label>
                    <input type="number" id="stock" name="stock" required min="0" placeholder="0 ì´ìƒì˜ ì¬ê³  ìˆ˜ëŸ‰">
                </div>

                <!--
                (â˜…ìˆ˜ì •)
                Resellerì¼ ê²½ìš°ì—ë§Œ 2ì°¨ íŒë§¤ í•„ë“œì™€ ê²½ë§¤ í•„ë“œ ì„¹ì…˜ì´ ë Œë”ë§ë©ë‹ˆë‹¤.
                -->
                {% if session.user_role == 'Reseller' %}
                <div id="reseller-fields">
                    <div class="form-group">
                        <label for="condition">ìƒí’ˆ ìƒíƒœ <span class="required">*</span></label>
                        <select id="condition" name="condition" required>
                            <option value="">-- ìƒí’ˆ ìƒíƒœ ì„ íƒ (í•„ìˆ˜) --</option>
                            <option value="ë¯¸ê°œë´‰">ë¯¸ê°œë´‰ (S)</option>
                            <option value="ìµœìƒ">ìµœìƒ (A)</option>
                            <option value="ì¤‘">ì¤‘ (B)</option>
                            <option value="í•˜">í•˜ (C)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="resale_images">ì‹¤ë¬¼ ì´ë¯¸ì§€ URL ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <textarea id="resale_images" name="resale_images" rows="3" placeholder="ì´ë¯¸ì§€ URLì„ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ListingImage)."></textarea>
                        <p class="note">âš ï¸ 2ì°¨ íŒë§¤ìëŠ” ì‹¤ë¬¼ ì‚¬ì§„ URLì„ ì…ë ¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
                    </div>

                    <div class="form-group auction-toggle">
                        <label>ê²½ë§¤ ë“±ë¡ ì—¬ë¶€</label>
                        <input type="checkbox" id="is_auction" name="is_auction" value="true">
                        <label for="is_auction" style="display: inline-block;">ì´ ìƒí’ˆì„ ê²½ë§¤ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.</label>
                    </div>
                </div>

                <!-- (â˜…ìˆ˜ì •) ê²½ë§¤ ìƒì„¸ ì •ë³´ divë¥¼ Reseller IF ë¸”ë¡ ì•ˆìœ¼ë¡œ ì´ë™ -->
                <div id="auction-details" class="hidden">
                    <h3>3. ê²½ë§¤ ìƒì„¸ ì •ë³´ (Auction)</h3>
                    <div class="form-group">
                        <label for="auction_start_price">ê²½ë§¤ ì‹œì‘ ê°€ê²© <span class="required">*</span></label>
                        <input type="number" id="auction_start_price" name="auction_start_price" placeholder="ê²½ë§¤ ì‹œì‘ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
                    </div>
                    <div class="form-group">
                        <label for="auction_start_date">ê²½ë§¤ ì‹œì‘ ì‹œê°„ <span class="required">*</span></label>
                        <input type="datetime-local" id="auction_start_date" name="auction_start_date">
                    </div>
                    <div class="form-group">
                        <label for="auction_end_date">ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ <span class="required">*</span></label>
                        <input type="datetime-local" id="auction_end_date" name="auction_end_date">
                    </div>
                </div>
                {% endif %} <!-- (â˜…ìˆ˜ì •) Reseller IF ë¸”ë¡ì„ ì—¬ê¸°ì„œ ë‹«ìŠµë‹ˆë‹¤. -->

            </div>

            <button type="submit" class="btn full-width submit-btn">ìƒí’ˆ ë“±ë¡ ì™„ë£Œ</button>

            <!-- (â˜…ì‹ ê·œ) AJAX ì‘ë‹µ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  div -->
            <div id="api-message" class="api-message" style="margin-top: 15px;"></div>
        </form>
    </div>

    <!-- (â˜…) í¼ ë‚´ë¶€ì˜ CSS/JSë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
<!--ë‹¤ì€ TODO: style ì˜®ê¸°ê¸°-->
    <style>
        .form-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 30px;
            background-color: var(--card-background);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .form-container.wide {
            max-width: 800px;
        }
        h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: var(--text-color-light);
            margin-top: 0;
            margin-bottom: 30px;
        }
        .form-group-section {
            margin-bottom: 25px;
        }
        .form-group-section h3 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .form-group .required {
            color: var(--resale-color);
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="email"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group input[type="datetime-local"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
            font-size: 1rem;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group .note {
            font-size: 0.9rem;
            color: var(--text-color-light);
            margin-top: 8px;
        }
        .form-group.auction-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #fcf8e3;
            border: 1px solid #faebcc;
            padding: 15px;
            border-radius: 6px;
        }
        .form-group.auction-toggle label {
            margin-bottom: 0;
            font-weight: bold;
        }
        .form-group.auction-toggle input[type="checkbox"] {
            width: auto;
            height: 1.2em;
            width: 1.2em;
        }

        /* ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
        .hidden {
            display: none;
        }
        .btn {
            display: inline-block;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn.full-width {
            width: 100%;
        }
        .btn.submit-btn {
            background-color: var(--primary-color);
            color: white;
            font-size: 1.1rem;
            padding: 15px;
        }
        .btn.submit-btn:hover {
            background-color: var(--button-primary-hover);
        }

        .api-message {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            border-radius: 6px;
        }

    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isAuctionCheckbox = document.getElementById('is_auction');
            const auctionDetailsDiv = document.getElementById('auction-details');

            // isAuctionCheckboxê°€ Resellerê°€ ì•„ë‹ˆë©´ nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²´í¬
            if (isAuctionCheckbox) {
                const requiredAuctionInputs = auctionDetailsDiv.querySelectorAll('input, select');

                function toggleAuctionFields() {
                    const isChecked = isAuctionCheckbox.checked;

                    if (isChecked) {
                        auctionDetailsDiv.classList.remove('hidden');
                        // ê²½ë§¤ í•„ë“œì— required ì†ì„± ì¶”ê°€
                        requiredAuctionInputs.forEach(input => input.setAttribute('required', 'required'));
                    } else {
                        auctionDetailsDiv.classList.add('hidden');
                        // ê²½ë§¤ í•„ë“œì˜ required ì†ì„± ì œê±°
                        requiredAuctionInputs.forEach(input => input.removeAttribute('required'));
                    }
                }

                isAuctionCheckbox.addEventListener('change', toggleAuctionFields);
                // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰
                toggleAuctionFields();
            }

            // --- (â˜…ì‹ ê·œ) AJAX í¼ ì œì¶œ ë¡œì§ ---
            const form = document.getElementById('product-register-form');
            const messageDiv = document.getElementById('api-message');

            form.addEventListener('submit', async function(event) {
                event.preventDefault(); // í¼ì˜ ê¸°ë³¸ ì œì¶œ(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨)ì„ ë§‰ìŒ

                const formData = new FormData(form);
                const data = {};

                formData.forEach((value, key) => {
                    // ì²´í¬ë°•ìŠ¤ëŠ” 'on' ë˜ëŠ” undefinedë¡œ ì˜¤ë¯€ë¡œ booleanìœ¼ë¡œ ë³€í™˜
                    if (key === 'is_auction') {
                        data[key] = true;
                    } else if (key === 'price' || key === 'stock' || key === 'auction_start_price') {
                        data[key] = value ? parseInt(value, 10) : null;
                    } else if (key === 'resale_images') {
                        // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ URLì„ ë°°ì—´ë¡œ ë³€í™˜
                        data[key] = value ? value.split(',').map(url => url.trim()).filter(url => url) : [];
                    } else {
                        data[key] = value;
                    }
                });

                // is_auctionì´ ì²´í¬ ì•ˆëì„ ë•Œ formDataì— í¬í•¨ì´ ì•ˆë˜ë¯€ë¡œ falseë¡œ ì„¤ì •
                if (!data.is_auction) {
                    data.is_auction = false;
                }

                messageDiv.textContent = 'ë“±ë¡ ì¤‘...';
                messageDiv.style.color = 'var(--text-color)';

                try {
                    const response = await fetch('/api/product_register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) { // HTTP ìƒíƒœ ì½”ë“œê°€ 200-299ì¼ ë•Œ
                        messageDiv.textContent = `${result.message} (Listing ID: ${result.listing_id})`;
                        messageDiv.style.color = 'var(--primary-color)';
                        form.reset(); // í¼ ì´ˆê¸°í™”

                        // 2ì´ˆ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);

                    } else { // HTTP ìƒíƒœ ì½”ë“œê°€ 4xx, 5xxì¼ ë•Œ
                        messageDiv.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${result.error || result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                        messageDiv.style.color = 'var(--resale-color)';
                    }

                } catch (error) {
                    console.error('Fetch error:', error);
                    messageDiv.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                    messageDiv.style.color = 'var(--resale-color)';
                }
            });
        });
    </script>
{% endblock %}