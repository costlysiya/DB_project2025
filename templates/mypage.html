{% extends "base.html" %}

{% block title %}ë§ˆì´í˜ì´ì§€ | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}
    
    <h2>ë§ˆì´í˜ì´ì§€</h2>
    
    <!-- ì‚¬ìš©ì í”„ë¡œí•„ ì„¹ì…˜ -->
    <div class="user-welcome-section">
        <p><strong>{{ user_profile.user.name }}</strong>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! (ì—­í• : <span class="user-role">{{ user_profile.user.role }}</span>)</p>
        <p>
            {% if user_profile.user.role == 'Buyer' %}
                í˜„ì¬ ë°°ì†¡ ì£¼ì†Œ: {{ user_profile.buyer_profile.address | default('ì£¼ì†Œ ë¯¸ë“±ë¡') }}
            {% elif user_profile.user.role in ['PrimarySeller', 'Reseller'] %}
                íŒë§¤ì ìƒì : {{ user_profile.seller_profile.store_name | default('ë¯¸ì§€ì •') }} |
                íŒë§¤ì ë“±ê¸‰: <span class="seller-grade-badge">{{ user_profile.seller_profile.grade | default('Bronze', true) }}</span>
            {% endif %}
        </p>
    </div>

    <div class="mypage-dashboard">

        <nav class="mypage-sidebar">
            <ul>
                <!-- ê¸°ë³¸ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ -->
                <li><a href="{{ url_for('show_mypage', view='profile') }}" class="{% if view == 'profile' %}active{% endif %}">ğŸ‘¤ ê°œì¸ ì •ë³´ ìˆ˜ì •</a></li>

                {% if user_profile.user.role == 'Buyer' %}
                <li><a href="{{ url_for('show_mypage', view='orders') }}" class="{% if view == 'orders' %}active{% endif %}">ğŸ“¦ ì£¼ë¬¸/ë°°ì†¡ ë‚´ì—­ ì¡°íšŒ</a></li>
                <li><a href="{{ url_for('show_mypage', view='disputes') }}" class="{% if view == 'disputes' %}active{% endif %}">ğŸ“ ë¶„ìŸ ì²˜ë¦¬ í˜„í™©</a></li>
                <li><a href="{{ url_for('show_mypage', view='feedback') }}" class="{% if view == 'feedback' %}active{% endif %}">â­ íŒë§¤ì í‰ê°€ ë‚¨ê¸°ê¸°</a></li>
                {% endif %}

                {% if user_profile.user.role in ['PrimarySeller', 'Reseller'] %}
                <li><a href="{{ url_for('show_mypage', view='my_products') }}" class="{% if view == 'my_products' %}active{% endif %}">ğŸ“ˆ ìƒí’ˆ ë“±ë¡ ë‚´ì—­</a></li>
                <li><a href="{{ url_for('show_mypage', view='sales') }}" class="{% if view == 'sales' %}active{% endif %}">ğŸ’° íŒë§¤ ë‚´ì—­ í™•ì¸</a></li>
                <li><a href="{{ url_for('show_mypage', view='evaluation') }}" class="{% if view == 'evaluation' %}active{% endif %}">â­ ë°›ì€ í‰ê°€ ë³´ê¸°</a></li>
                {% endif %}

                {% if user_profile.user.role == 'Administrator' %}
                <li><a href="{{ url_for('show_mypage', view='admin_rating') }}" class="{% if view == 'admin_rating' %}active{% endif %}">ğŸ’ êµ¿ì¦ˆ ë“±ê¸‰ ë¶€ì—¬</a></li>
                <li><a href="{{ url_for('show_mypage', view='admin_disputes') }}" class="{% if view == 'admin_disputes' %}active{% endif %}">ğŸ“ ë¶„ìŸ ì¡°ì •</a></li>
                <li><a href="{{ url_for('show_mypage', view='admin_seller_eval') }}" class="{% if view == 'admin_seller_eval' %}active{% endif %}">ğŸ† íŒë§¤ì í‰ê°€ ê´€ë¦¬</a></li>
                {% endif %}

            </ul>
        </nav>

        <div class="mypage-content">
<!--ë‹¤ì€ TODO: ë™ì ìœ¼ë¡œ ë³´ì´ëŠ” ë¶€ë¶„ì—ì„œ í‘œ style ìˆ˜ì • í•„ìš” (ë„ˆë¬´ ë¶™ì–´ì‡ìŒ)-->
            {% if not view %}
            <h3>ë§¤ë‰´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</h3>
            {% elif view == 'orders' %}
                <!-- ì£¼ë¬¸/ë°°ì†¡ ë‚´ì—­ ì¡°íšŒ (Buyer) -->
                <h3>ğŸ“¦ ì£¼ë¬¸/ë°°ì†¡ ë‚´ì—­ ì¡°íšŒ</h3>
                {% if orders %}
                    <p>ì´ {{ orders | length }}ê±´ì˜ ì£¼ë¬¸ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <!-- ì£¼ë¬¸ ëª©ë¡ í…Œì´ë¸” ë Œë”ë§ -->
                    <table class="order-history-table">
                        <thead>
                            <tr>
                                <th>ì£¼ë¬¸ ìƒí’ˆ</th>
                                <th>íŒë§¤ì</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ê²°ì œ ê¸ˆì•¡</th>
                                <th>ì£¼ë¬¸ ì¼ì‹œ</th>
                                <th>ë°°ì†¡ ìƒíƒœ</th>
                                <th>í™˜ë¶ˆ/êµí™˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('show_product_detail', listing_id=order.listing_id) }}">
                                        <img src="{{ order.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ order.product_name }}" width="40" height="40" style="margin-right: 10px; border-radius: 4px; vertical-align: middle;">
                                        {{ order.product_name }}
                                    </a>
                                </td>
                                <td>{{ order.seller_name }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>{{ "{:,.0f}ì›".format(order.total_price) }}</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ order.status }}</td>
                                <td>
                                    {% if order.status == 'ë°°ì†¡ ì™„ë£Œ' %}
                                        <button class="btn dispute-btn btn-refund" onclick="showDisputeModal({{ order.order_id }}, 'í™˜ë¶ˆ')">
                                            í™˜ë¶ˆ ìš”ì²­
                                        </button>
                                        <button class="btn dispute-btn btn-exchange" onclick="showDisputeModal({{ order.order_id }}, 'êµí™˜')">
                                            êµí™˜ ìš”ì²­
                                        </button>
                                    {% elif order.status in ['í™˜ë¶ˆ', 'êµí™˜'] %}
                                        <span class="status-dispute">{{ order.status }} ì²˜ë¦¬ ì¤‘</span>
                                    {% else %}
                                         -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}

            {% elif view == 'my_products' %}
            <!--ìƒí’ˆ ëª©ë¡ (Seller)-->
            <h3>ğŸ“ˆ ë‚´ ìƒí’ˆ ëª©ë¡ (ì¬ê³  ê´€ë¦¬)</h3>

            <!-- (â˜…) AJAX ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            <div id="update-message-area" style="margin: 15px 0; padding: 10px; border-radius: 6px; display: none; font-weight: bold;"></div>

            {% if my_products %}
                <p>ì´ {{ my_products | length }}ê±´ì˜ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤.</p>
                <table class="order-history-table">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆ ì •ë³´ (ì´ë¦„)</th>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>ê°€ê²© (ì›)</th>
                            <th>ì¬ê³  (ê°œ)</th>
                            <th>íŒë§¤ ìƒíƒœ</th>
                            <th>ì»¨ë””ì…˜</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in my_products %}
                        <!--JavaScriptê°€ í–‰(row)ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ID ë¶€ì—¬ -->
                        <tr id="row-{{ product.listing_id }}">
                            <!-- Product IDë¥¼ ìˆ¨ê²¨ë‘  (ì—…ë°ì´íŠ¸ ì‹œ í•„ìš”) -->
                            <input type="hidden" class="product-id-input" value="{{ product.product_id }}">

                            <td>
                                <a href="{{ url_for('show_product_detail', listing_id=product.listing_id) }}" style="display: flex; align-items: center;">
                                    <img src="{{ product.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ product.product_name }}" width="40" height="40" style="margin-right: 10px; border-radius: 4px;">
                                </a>
                                <!-- ìƒí’ˆëª… Input -->
                                <input type="text" class="form-control product-name-input" value="{{ product.product_name }}"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                            </td>
                            <td>
                                <!-- ì¹´í…Œê³ ë¦¬ Select -->
                                    <select class="form-control category-select"
                                    {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                                        {% for cat in ['ìŒë°˜', 'í”¼ê·œì–´', 'ì¸í˜•', 'ì•„í¬ë¦´', 'ì‘ì›ë„êµ¬', 'í¬ì¹´', 'ì˜ë¥˜', 'ê¸°íƒ€'] %}
                                        <option value="{{ cat }}" {% if product.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                            </td>
                            <td>
                                <!--ê°€ê²© Input -->
                                <input type="number" class="form-control price-input" value="{{ product.price }}" min="0"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                            </td>
                            <td>
                                <!--ì¬ê³  Input -->
                                <input type="number" class="form-control stock-input" value="{{ product.stock }}" min="0"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                            </td>

                            <td data-field="listing_status" class="editable-cell">

                                <!-- íŒë§¤ ìƒíƒœ Select -->
                                <select class="form-control status-select"
                                        data-current-value="{{ product.listing_status }}"
                                        {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}
                                            disabled style="background-color: #e9ecef; cursor: not-allowed;"
                                        {% endif %}>

                                    {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}
                                        <!-- ê²½ë§¤ ìƒí’ˆì´ë©´ í˜„ì¬ ìƒíƒœë§Œ í‘œì‹œ -->
                                        <option value="{{ product.listing_status }}" selected>{{ product.listing_status }}</option>
                                    {% else %}
                                        <!-- ì¼ë°˜ ìƒí’ˆì´ë©´ í˜„ì¬ ìƒíƒœì™€ íŒë§¤ ì˜µì…˜ í‘œì‹œ -->
                                        {% for stat in ['íŒë§¤ì¤‘', 'í’ˆì ˆ'] %}
                                            <option value="{{ stat }}" {% if product.listing_status == stat %}selected{% endif %}>{{ stat }}</option>
                                        {% endfor %}
                                    {% endif %}

                                </select>

                                <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}
                                    <small style="display: block; color: #dc3545; margin-top: 5px; font-size: 0.8em;">
                                        âš ï¸ ê²½ë§¤ ìƒí’ˆì€ ìƒíƒœ ë³€ê²½ ë¶ˆê°€
                                    </small>
                                {% endif %}

                                {% if product.stock == 0 and product.listing_status == 'íŒë§¤ì¤‘' %}
                                    <small style="display: block; color: #dc3545; margin-top: 5px; font-size: 0.8em;">
                                        âš ï¸ íŒë§¤ì¤‘ì¸ ìƒí’ˆì˜ ì¬ê³ ëŠ” 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                <!--ì»¨ë””ì…˜ Input (Resellerë§Œ í™œì„±í™”) -->
                                    <select class="form-control condition-select" {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] or user_profile.user.role != 'Reseller' %}disabled{% endif %}>
                                        <option value="ë¯¸ê°œë´‰" {% if product.condition == 'ë¯¸ê°œë´‰' %}selected{% endif %}>ë¯¸ê°œë´‰ (S)</option>
                                        <option value="ìµœìƒ" {% if product.condition == 'ìµœìƒ' %}selected{% endif %}>ìµœìƒ (A)</option>
                                        <option value="ì¤‘" {% if product.condition == 'ì¤‘' %}selected{% endif %}>ì¤‘ (B)</option>
                                        <option value="í•˜" {% if product.condition == 'í•˜' %}selected{% endif %}>í•˜ (C)</option>
                                    </select>
                            </td>
                            <td>
                                <!-- ì €ì¥ ë²„íŠ¼ (onclick ì´ë²¤íŠ¸ ì—°ê²°) -->
                                <button class="btn primary-btn" onclick="saveProductUpdate({{ product.listing_id }})"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %} disabled style="background-color:#999; cursor:not-allowed;"
                                {% endif %}>ì €ì¥</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>ë“±ë¡í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. <a href="{{ url_for('show_product_register_page') }}">ìƒí’ˆì„ ë“±ë¡</a>í•´ë³´ì„¸ìš”.</p>
            {% endif %}

            <!-- ë‹¤ì€ TODO: styleëº´ê¸°. -->
            <style>
                .form-control {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                }
                .order-history-table td {
                    vertical-align: middle;
                    min-width: 120px;
                }
                .order-history-table td input[type="number"] {
                    width: 80px;
                }
            </style>

            {% elif view == 'sales' %}
            <h3>ğŸ’° íŒë§¤ ë‚´ì—­(ì£¼ë¬¸ ë‚´ì—­)</h3>
                <!--íŒë§¤ ë‚´ì—­(Seller)-->
                {% if sales_orders %}
                    <p>ì´ {{ sales_orders | length }}ê±´ì˜ íŒë§¤ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <table class="order-history-table">
                        <thead>
                            <tr>
                                <th>ìƒí’ˆ ì •ë³´</th>
                                <th>êµ¬ë§¤ì</th>
                                <th>ì£¼ì†Œ</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ì´ ê¸ˆì•¡</th>
                                <th>ì£¼ë¬¸ ì¼ì‹œ</th>
                                <th>ì²˜ë¦¬ ìƒíƒœ</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in sales_orders %}
                            <tr data-order-id="{{ order.order_id }}">
                                <td>
                                    <a href="{{ url_for('show_product_detail', listing_id=order.listing_id) }}">
                                        <img src="{{ order.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ order.product_name }}" width="40" height="40" style="margin-right: 10px; border-radius: 4px; vertical-align: middle;">
                                        {{ order.product_name }}
                                    </a>
                                </td>
                                <td>{{ order.buyer_name }} ({{ order.buyer_uid }})</td>
                                <td>{{ order.buyer_address }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>{{ "{:,.0f}ì›".format(order.total_price) }}</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="order-status-{{ order.order_id }}">{{ order.status }}</td>
                                <td>
                                    <!--  ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ë²„íŠ¼ (í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°) -->
                                    <button class="btn update-status-btn"
                                            data-order-id="{{ order.order_id }}"
                                            data-current-status="{{ order.status }}"
                                            {% if order.status in ['ë°°ì†¡ ì™„ë£Œ', 'í™˜ë¶ˆ', 'êµí™˜'] %} disabled {% endif %}
                                            style="{% if order.status == 'ë°°ì†¡ ì¤‘' %} background-color: orange; {% elif order.status == 'ìƒí’ˆ ì¤€ë¹„ì¤‘' %} background-color: #007bff; {% else %} background-color: #6c757d; {% endif %} color: white; border: none; padding: 5px 10px; border-radius: 4px;">
                                        {{ 'ë°°ì†¡ ì²˜ë¦¬' if order.status == 'ìƒí’ˆ ì¤€ë¹„ì¤‘' else 'ì¶œê³  ì™„ë£Œ' if order.status == 'ë°°ì†¡ ì¤‘' else 'ìƒíƒœ ë³€ê²½ ë¶ˆê°€' }}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>ìµœê·¼ íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}

            {% elif view == 'evaluation' %}
            <!-- TODO: ë°›ì€ í‰ê°€ ë³´ê¸° (Seller) -->
            <h3>â­ ë°›ì€ í‰ê°€ ë³´ê¸°</h3>
            <p>êµ¬ë§¤ìë“¤ì´ ë‚¨ê¸´ íŒë§¤ì í‰ê°€ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>

            {% elif view == 'disputes' %}
            <!-- TODO: ë¶„ìŸ ì²˜ë¦¬ í˜„í™© (Buyer) -->
            <h3>ğŸ“ ë¶„ìŸ ì²˜ë¦¬ í˜„í™©</h3>
            <p>í™˜ë¶ˆ/êµí™˜ ìš”ì²­ ëª©ë¡ê³¼ ì²˜ë¦¬ ìƒíƒœê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>

            {% elif view == 'feedback' %}
            <!-- TODO: íŒë§¤ì í‰ê°€ (Buyer) -->
            <h3>â­ íŒë§¤ì í‰ê°€ ë‚¨ê¸°ê¸°</h3>
            <p>ê±°ë˜ê°€ ëë‚œ ìƒí’ˆì— ëŒ€í•´ íŒë§¤ì í‰ê°€í•˜ê¸°.</p>

            {% elif view == 'profile' %}
            <h3>ğŸ‘¤ íšŒì› ì •ë³´ ìˆ˜ì •</h3>
            <p class="subtitle">í•„ìš”í•œ í•­ëª©ë§Œ ì…ë ¥í•˜ê³  ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            <div class="form-container wide" style="margin: 0 auto; box-shadow: none; border: none;">
                <form id="profile-update-form">
                    <!-- ê³µí†µ ì •ë³´ -->
                    <div class="form-group-section">
                        <h3>ê¸°ë³¸ ê³„ì • ì •ë³´</h3>
                        <div class="form-group">
                            <label for="uid">ì•„ì´ë”” (ë¡œê·¸ì¸ ID)</label>
                            <!-- user_uidëŠ” ìˆ˜ì • ë¶ˆê°€ -->
                            <input type="text" id="uid" value="{{ user_profile.user.user_uid }}" disabled style="background-color: #f5f5f5;">
                        </div>

                        <div class="form-group">
                            <label for="name">ì´ë¦„/í™œë™ëª…</label>
                            <input type="text" id="name" name="name" value="{{ user_profile.user.name }}" required>
                            <p class="note">í˜„ì¬ ì´ë¦„: <strong>{{ user_profile.user.name }}</strong></p>
                        </div>

                        <div class="form-group">
                            <label for="password">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label>
                            <input type="password" id="password" name="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¯¸ì…ë ¥ ì‹œ ë³€ê²½ ì•ˆ í•¨)">
                        </div>
                    </div>
                    <hr>
                    <!-- ì—­í• ë³„ ì •ë³´ -->
                    {% if user_profile.user.role == 'Buyer' %}
                    <div class="form-group-section">
                        <h3>ë°°ì†¡ ì •ë³´ (êµ¬ë§¤ì ì „ìš©)</h3>
                        <div class="form-group">
                            <label for="address">ê¸°ë³¸ ë°°ì†¡ ì£¼ì†Œ</label>
                            <input type="text" id="address" name="address"
                                   value="{{ user_profile.buyer_profile.address | default('') }}"
                                   placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
                        </div>
                    </div>

                    {% elif user_profile.user.role in ['PrimarySeller', 'Reseller'] %}
                    <div class="form-group-section">
                        <h3>íŒë§¤ì ì •ë³´</h3>
                        <div class="form-group">
                            <label for="store_name">ìƒì ëª… (Seller ì „ìš©)</label>
                            <input type="text" id="store_name" name="store_name"
                                   value="{{ user_profile.seller_profile.store_name | default('') }}"
                                   placeholder="ìƒì ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>

                    {% elif user_profile.user.role == 'Administrator' %}
                    <div class="form-group-section">
                        <h3>ê´€ë¦¬ì ê³„ì •</h3>
                        <p class="note" style="color: green;">ê´€ë¦¬ì ê³„ì •ì€ ì´ë¦„/ë¹„ë°€ë²ˆí˜¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    {% endif %}

                    <button type="submit" class="btn full-width submit-btn" style="margin-top: 30px;">ì •ë³´ ìˆ˜ì • ì™„ë£Œ</button>
                    <div id="api-message" class="message-box" style="margin-top: 15px;"></div>
                </form>
            </div>
            {% elif view == 'admin_rating' %}
            <h3>ğŸ’ êµ¿ì¦ˆ ë“±ê¸‰ ë¶€ì—¬</h3>
<!--            TODO: êµ¿ì¦ˆ ë“±ê¸‰ ë¶€ì—¬ ê¸°ëŠ¥ êµ¬í˜„ (admin)-->
            {% elif view == 'admin_disputes' %}
            <h3>ğŸ“ ë¶„ìŸ ì¡°ì •</h3>
<!--            TODO: ë¶„ìŸ ì¡°ì • ê¸°ëŠ¥ êµ¬í˜„(admin)-->
            {% elif view == 'admin_seller_eval' %}
            <h3>ğŸ† íŒë§¤ì í‰ê°€ ê´€ë¦¬</h3>
<!--            TODO: íŒë§¤ì í‰ê°€ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„(admin)-->
            {% endif %}


            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // ë§ˆì´í˜ì´ì§€ íŒë§¤ì ì£¼ë¬¸ ë‚´ì—­ì—ì„œë§Œ ì‹¤í–‰
                    const updateStatusBtns = document.querySelectorAll('.update-status-btn');

                    const getNextStatusInfo = (currentStatus) => {
                        if (currentStatus === 'ìƒí’ˆ ì¤€ë¹„ì¤‘') {
                            return { next: 'ë°°ì†¡ ì¤‘', confirmMsg: 'ì£¼ë¬¸ ìƒíƒœë¥¼ [ë°°ì†¡ ì¤‘]ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' };
                        } else if (currentStatus === 'ë°°ì†¡ ì¤‘') {
                            return { next: 'ë°°ì†¡ ì™„ë£Œ', confirmMsg: 'ì£¼ë¬¸ ìƒíƒœë¥¼ [ë°°ì†¡ ì™„ë£Œ]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' };
                        }
                        return null; // ë³€ê²½ ë¶ˆê°€ëŠ¥ ìƒíƒœ
                    };

                    updateStatusBtns.forEach(button => {
                        button.addEventListener('click', async function() {
                            const orderId = this.getAttribute('data-order-id');
                            const currentStatus = this.getAttribute('data-current-status');
                            const statusInfo = getNextStatusInfo(currentStatus);

                            if (!statusInfo) {
                                alert(`ì£¼ë¬¸ ìƒíƒœ '${currentStatus}'ëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                                return;
                            }

                            if (!confirm(statusInfo.confirmMsg)) {
                                return;
                            }

                            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
                            this.disabled = true;
                            this.textContent = 'ì²˜ë¦¬ ì¤‘...';

                            try {
                                const response = await fetch('/api/order/update_status', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ order_id: orderId })
                                });

                                const result = await response.json();
                                const statusCell = document.querySelector(`.order-status-${orderId}`);

                                if (response.ok) {
                                    const newStatus = result.new_status;
                                    alert(`ìƒíƒœ ë³€ê²½ ì„±ê³µ: ${newStatus}`);

                                    // UI ì—…ë°ì´íŠ¸
                                    statusCell.textContent = newStatus;
                                    this.setAttribute('data-current-status', newStatus);

                                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ìƒíƒœë¥¼ ìœ„í•œ ì¤€ë¹„)
                                    if (newStatus === 'ë°°ì†¡ ì¤‘') {
                                        this.textContent = 'ì¶œê³  ì™„ë£Œ';
                                        this.style.backgroundColor = 'orange';
                                        this.disabled = false; // ë‹¤ìŒ ìƒíƒœë¡œì˜ ë³€ê²½ í—ˆìš©
                                    } else if (newStatus === 'ë°°ì†¡ ì™„ë£Œ') {
                                        this.textContent = 'ìƒíƒœ ë³€ê²½ ë¶ˆê°€';
                                        this.style.backgroundColor = '#6c757d';
                                        this.disabled = true; // ìµœì¢… ìƒíƒœì´ë¯€ë¡œ ë¹„í™œì„±í™”
                                    }
                                } else {
                                    alert(`ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${result.error || result.message}`);
                                    // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë¡¤ë°±
                                    this.textContent = currentStatus === 'ìƒí’ˆ ì¤€ë¹„ì¤‘' ? 'ë°°ì†¡ ì²˜ë¦¬' : 'ì¶œê³  ì™„ë£Œ';
                                    this.disabled = false;
                                }

                            } catch (error) {
                                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë¡¤ë°±
                                this.textContent = currentStatus === 'ìƒí’ˆ ì¤€ë¹„ì¤‘' ? 'ë°°ì†¡ ì²˜ë¦¬' : 'ì¶œê³  ì™„ë£Œ';
                                this.disabled = false;
                            }
                        });
                    });
                });
                //ë¶„ìŸ ì²˜ë¦¬ ê´€ë ¨ JSë¡œì§
                function showDisputeModal(orderId, issueType) {
                    const reason = prompt(`ì£¼ë¬¸ #${orderId}ì— ëŒ€í•œ ${issueType} ìš”ì²­ ì‚¬ìœ ë¥¼ ê°„ë‹¨íˆ ì…ë ¥í•´ì£¼ì„¸ìš”:`);

                    if (reason) {
                    //TODO:
                        // ì‹¤ì œ API í˜¸ì¶œ ë¡œì§ (Dispute í…Œì´ë¸”ì— INSERT)
                        // í˜„ì¬ëŠ” êµ¬í˜„ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ alertë¡œ ëŒ€ì²´
                        alert(`[${issueType} ìš”ì²­ ì ‘ìˆ˜]\nì£¼ë¬¸ ID: ${orderId}\nì‚¬ìœ : "${reason}"\n\nâš ï¸ ì‹¤ì œ ë¶„ìŸ ì²˜ë¦¬ API('/api/dispute/create') êµ¬í˜„ í•„ìš”.`);
                        // TODO: ì„±ê³µ ê°€ì • ì‹œ '/api/dispute/create'ë¥¼ í˜¸ì¶œí•˜ê³ , ì„±ê³µí•˜ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒíƒœë¥¼ 'í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘' ë“±ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•¨.
                    }
                }
                //ê°œì¸ ì •ë³´ ìˆ˜ì • ê´€ë ¨ ë¡œì§
                                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.getElementById('profile-update-form');
                    const messageArea = document.getElementById('api-message');

                    form.addEventListener('submit', async function(event) {
                        event.preventDefault();

                        messageArea.textContent = 'ì •ë³´ ìˆ˜ì • ìš”ì²­ ì¤‘...';
                        messageArea.style.color = 'gray';

                        const formData = new FormData(form);
                        const data = {
                            password: formData.get('password'),
                            name: formData.get('name'),
                        };

                        // ì—­í• ë³„ í•„ë“œ ì¶”ê°€
                        if (formData.has('address')) {
                            data.address = formData.get('address');
                        }
                        if (formData.has('store_name')) {
                            data.store_name = formData.get('store_name');
                        }

                        try {
                            const response = await fetch('/api/mypage/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });

                            const result = await response.json();

                            if (response.ok) {
                                messageArea.textContent = result.message;
                                messageArea.style.color = '#2ecc71'; // ì„±ê³µ ìƒ‰ìƒ
                                // ìˆ˜ì • ì„±ê³µ í›„ ì„¸ì…˜ ì •ë³´ ê°±ì‹ ì„ ìœ„í•´ ë§ˆì´í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ë·°ëŠ” profile ìœ ì§€)
                                setTimeout(() => {
                                    window.location.href = '{{ url_for("show_mypage", view="profile") }}';
                                }, 1500);
                            } else {
                                messageArea.textContent = `ìˆ˜ì • ì‹¤íŒ¨: ${result.error || result.message}`;
                                messageArea.style.color = '#dc3545'; // ì‹¤íŒ¨ ìƒ‰ìƒ
                            }

                        } catch (error) {
                            messageArea.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                            messageArea.style.color = '#dc3545';
                        }
                    });
                });

                // ìƒí’ˆ ì •ë³´ ìˆ˜ì • (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
                async function saveProductUpdate(listingId) {
                    const row = document.getElementById('row-' + listingId);
                    const messageArea = document.getElementById('update-message-area');

                    if (!row) {
                        alert("ì˜¤ë¥˜: í•´ë‹¹ ìƒí’ˆ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // 1. í–‰(row) ë‚´ë¶€ì—ì„œ ìˆ˜ì •ëœ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
                    const data = {
                        listing_id: listingId,
                        product_id: row.querySelector('.product-id-input').value,
                        product_name: row.querySelector('.product-name-input').value,
                        category: row.querySelector('.category-select').value,
                        price: row.querySelector('.price-input').value,
                        stock: row.querySelector('.stock-input').value,
                        listing_status: row.querySelector('.status-select').value,
                        condition: row.querySelector('.condition-select').value
                    };

                    messageArea.textContent = `ìƒí’ˆ(ID: ${listingId}) ì €ì¥ ì¤‘...`;
                    messageArea.style.color = 'blue';
                    messageArea.style.display = 'block';

                    try {
                        // 2. /api/seller/product/update API í˜¸ì¶œ
                        const response = await fetch('/api/seller/product/update', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            messageArea.textContent = `âœ… ${result.message}`;
                            messageArea.style.color = 'green';
                        } else {
                            messageArea.textContent = `âŒ ì €ì¥ ì‹¤íŒ¨: ${result.error || result.message}`;
                            messageArea.style.color = 'red';
                        }

                    } catch (error) {
                        messageArea.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                        messageArea.style.color = 'red';
                    }

                    // 3ì´ˆ ë’¤ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        messageArea.style.display = 'none';
                    }, 3000);
                }
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".status-select").forEach(select => {
        select.addEventListener("change", function() {
            const row = select.closest("tr");
            const stock = row.querySelector(".stock-input").value;

            // ì¬ê³ =0 ì´ë©´ì„œ ìƒíƒœ=íŒë§¤ì¤‘ì¸ ê²½ìš° ë°©ì§€
            if (this.value === "íŒë§¤ì¤‘" && parseInt(stock) === 0) {
                alert("ì¬ê³ ê°€ 0ê°œì¸ ìƒí’ˆì€ 'íŒë§¤ì¤‘' ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                this.value = "í’ˆì ˆ";   // ìë™ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
            }
        });
    });
});

document.querySelectorAll(".stock-input").forEach(input => {
    input.addEventListener("input", function () {
        const row = input.closest("tr");
        const statusSelect = row.querySelector(".status-select");

        if (parseInt(this.value) === 0 && statusSelect.value === "íŒë§¤ì¤‘") {
            statusSelect.value = "í’ˆì ˆ";
        }
    });
});


            </script>
        </div>
    </div>
{% endblock %}