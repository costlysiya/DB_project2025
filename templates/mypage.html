{% extends "base.html" %}

{% block title %}ë§ˆì´í˜ì´ì§€ | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}
    
    <h2>ë§ˆì´í˜ì´ì§€</h2>
    
    <!-- ì‚¬ìš©ì í”„ë¡œí•„ ì„¹ì…˜ -->
    <div class="user-welcome-section">
        <p><strong>{{ user_profile.user.name }}</strong>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! (ì—­í• : <span class="user-role">{{ user_profile.user.role }}</span>)</p>
        <p>
            {% if user_profile.user.role == 'Buyer' %}
                í˜„ì¬ ë°°ì†¡ ì£¼ì†Œ: {{ user_profile.buyer_profile.address | default('ì£¼ì†Œ ë¯¸ë“±ë¡') }}
            {% elif user_profile.user.role in ['PrimarySeller', 'Reseller'] %}
                íŒë§¤ì ìƒì : {{ user_profile.seller_profile.store_name | default('ë¯¸ì§€ì •') }} |
                íŒë§¤ì ë“±ê¸‰: <span class="seller-grade-badge">{{ user_profile.seller_profile.grade}}</span>
            {% endif %}
        </p>
    </div>

    <div class="mypage-dashboard">

        <nav class="mypage-sidebar">
            <ul>
                <!-- ê¸°ë³¸ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ -->
                <li><a href="{{ url_for('show_mypage', view='profile') }}" class="{% if view == 'profile' %}active{% endif %}">ğŸ‘¤ ê°œì¸ ì •ë³´ ìˆ˜ì •</a></li>

                {% if user_profile.user.role == 'Buyer' %}
                <li><a href="{{ url_for('show_mypage', view='orders') }}" class="{% if view == 'orders' %}active{% endif %}">ğŸ“¦ ì£¼ë¬¸/ë°°ì†¡ ë‚´ì—­ ì¡°íšŒ</a></li>
                <li><a href="{{ url_for('show_mypage', view='disputes') }}" class="{% if view == 'disputes' %}active{% endif %}">ğŸ“ ë¶„ìŸ ì²˜ë¦¬ í˜„í™©</a></li>
                <li><a href="{{ url_for('show_mypage', view='feedback') }}" class="{% if view == 'feedback' %}active{% endif %}">â­ í›„ê¸° ë‚¨ê¸°ê¸°</a></li>
                {% endif %}

                {% if user_profile.user.role in ['PrimarySeller', 'Reseller'] %}
                <li><a href="{{ url_for('show_mypage', view='my_products') }}" class="{% if view == 'my_products' %}active{% endif %}">ğŸ“ˆ ìƒí’ˆ ë“±ë¡ ë‚´ì—­</a></li>
                <li><a href="{{ url_for('show_mypage', view='sales') }}" class="{% if view == 'sales' %}active{% endif %}">ğŸ’° íŒë§¤ ë‚´ì—­ í™•ì¸</a></li>
                {% endif %}

                {% if user_profile.user.role == 'Administrator' %}
                <li><a href="{{ url_for('show_mypage', view='admin_rating') }}" class="{% if view == 'admin_rating' %}active{% endif %}">ğŸ’ êµ¿ì¦ˆ ë“±ê¸‰ ë¶€ì—¬</a></li>
                <li><a href="{{ url_for('show_mypage', view='admin_disputes') }}" class="{% if view == 'admin_disputes' %}active{% endif %}">ğŸ“ ë¶„ìŸ ì¡°ì •</a></li>
                <li><a href="{{ url_for('show_mypage', view='admin_seller_eval') }}" class="{% if view == 'admin_seller_eval' %}active{% endif %}">ğŸ† íŒë§¤ì í‰ê°€ ê´€ë¦¬</a></li>
                {% endif %}

            </ul>
        </nav>

        <div class="mypage-content">
            {% if not view %}
            <h3>ë§¤ë‰´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</h3>
            {% elif view == 'orders' %}
                <!-- ì£¼ë¬¸/ë°°ì†¡ ë‚´ì—­ ì¡°íšŒ (Buyer) -->
                <h3>ğŸ“¦ ì£¼ë¬¸/ë°°ì†¡ ë‚´ì—­ ì¡°íšŒ</h3>
                {% if orders %}
                    <p>ì´ {{ orders | length }}ê±´ì˜ ì£¼ë¬¸ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <!-- ì£¼ë¬¸ ëª©ë¡ í…Œì´ë¸” ë Œë”ë§ -->
                    <table class="order-history-table">
                        <thead>
                            <tr>
                                <th>ì£¼ë¬¸ ìƒí’ˆ</th>
                                <th>íŒë§¤ì</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ê²°ì œ ê¸ˆì•¡</th>
                                <th>ì£¼ë¬¸ ì¼ì‹œ</th>
                                <th>ë°°ì†¡ ìƒíƒœ</th>
                                <th>í™˜ë¶ˆ/êµí™˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('show_product_detail', listing_id=order.listing_id) }}">
                                        <img src="{{ order.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ order.product_name }}" width="40" height="40" style="margin-right: 10px; border-radius: 4px; vertical-align: middle;">
                                        {{ order.product_name }}
                                    </a>
                                </td>
                                <td>{{ order.seller_name }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>{{ "{:,.0f}ì›".format(order.total_price) }}</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ order.status }}</td>
                                <td class="action-cell">
                                    {% if order.status == 'ë°°ì†¡ ì™„ë£Œ' %}
                                        <button class="btn dispute-btn btn-refund" onclick="showDisputeModal({{ order.order_id }}, 'í™˜ë¶ˆ')">
                                            í™˜ë¶ˆ ìš”ì²­
                                        </button>
                                        <button class="btn dispute-btn btn-exchange" onclick="showDisputeModal({{ order.order_id }}, 'êµí™˜')">
                                            êµí™˜ ìš”ì²­
                                        </button>
                                        <button class="btn btn-success" onclick="confirmPurchase({{ order.order_id }})">
                                            êµ¬ë§¤ í™•ì •
                                        </button>
                                    {% elif order.status == 'êµ¬ë§¤ í™•ì •' %}
                                        <span class="status-success">âœ… í™•ì • ì™„ë£Œ</span>
                                    {% elif order.status in ['í™˜ë¶ˆ', 'êµí™˜'] %}
                                        {% if order.dispute_status == 'ì²˜ë¦¬ ì™„ë£Œ' %}
                                            {% if order.status == 'í™˜ë¶ˆ' %}
                                                <span class="status-dispute status-refund-complete">âœ… í™˜ë¶ˆ ì™„ë£Œ</span>
                                            {% elif order.status == 'êµí™˜' %}
                                                <span class="status-dispute status-exchange-complete">âœ… êµí™˜ ì™„ë£Œ</span>
                                            {% endif %}
                                        {% elif order.dispute_status == 'ì²˜ë¦¬ ì¤‘' %}
                                            <span class="status-dispute status-processing">{{ order.status }} ì²˜ë¦¬ ì¤‘</span>
                                        {% elif order.dispute_status == 'ì²˜ë¦¬ ì „' %}
                                            <span class="status-dispute status-pending">ìš”ì²­ ì ‘ìˆ˜ ëŒ€ê¸°</span>
                                        {% else %}
                                            -
                                            <!--<span class="status-dispute status-processing">{{ order.status }} ì²˜ë¦¬ ì¤‘</span> -->
                                        {% endif %}
                                    {% else %}
                                         -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}

            {% elif view == 'my_products' %}
            <!--ìƒí’ˆ ëª©ë¡ (Seller)-->
            <h3>ğŸ“ˆ ë‚´ ìƒí’ˆ ëª©ë¡ (ì¬ê³  ê´€ë¦¬)</h3>

            <!-- (â˜…) AJAX ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            <div id="update-message-area" style="margin: 15px 0; padding: 10px; border-radius: 6px; display: none; font-weight: bold;"></div>

            {% if my_products %}
                <p>ì´ {{ my_products | length }}ê±´ì˜ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤.</p>
                <table class="order-history-table">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆ ì •ë³´ (ì´ë¦„)</th>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>ê°€ê²© (ì›)</th>
                            <th>ì¬ê³  (ê°œ)</th>
                            <th>íŒë§¤ ìƒíƒœ</th>
                            <th>ì»¨ë””ì…˜</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in my_products %}
                        <!--JavaScriptê°€ í–‰(row)ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ID ë¶€ì—¬ -->
                        <tr id="row-{{ product.listing_id }}">
                            <!-- Product IDë¥¼ ìˆ¨ê²¨ë‘  (ì—…ë°ì´íŠ¸ ì‹œ í•„ìš”) -->
                            <input type="hidden" class="product-id-input" value="{{ product.product_id }}">

                            <td>
                                <a href="{{ url_for('show_product_detail', listing_id=product.listing_id) }}" style="display: flex; align-items: center;">
                                    <img src="{{ product.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ product.product_name }}" width="40" height="40" style="margin-right: 10px; border-radius: 4px;">
                                </a>
                                <!-- ìƒí’ˆëª… Input -->
                                <input type="text" class="form-control product-name-input" value="{{ product.product_name }}"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                            </td>
                            <td>
                                <!-- ì¹´í…Œê³ ë¦¬ Select -->
                                    <select class="form-control category-select"
                                    {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                                        {% for cat in ['ìŒë°˜', 'í”¼ê·œì–´', 'ì¸í˜•', 'ì•„í¬ë¦´', 'ì‘ì›ë„êµ¬', 'í¬ì¹´', 'ì˜ë¥˜', 'ê¸°íƒ€'] %}
                                        <option value="{{ cat }}" {% if product.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                            </td>
                            <td>
                                <!--ê°€ê²© Input -->
                                <input type="number" class="form-control price-input" value="{{ product.price }}" min="0"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                            </td>
                            <td>
                                <!--ì¬ê³  Input -->
                                <input type="number" class="form-control stock-input" value="{{ product.stock }}" min="0"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}disabled style="background-color:#e9ecef;"{% endif %}>
                            </td>

                            <td data-field="listing_status" class="editable-cell">

                                <!-- íŒë§¤ ìƒíƒœ Select -->
                                <select class="form-control status-select"
                                        data-current-value="{{ product.listing_status }}"
                                        {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}
                                            disabled style="background-color: #e9ecef; cursor: not-allowed;"
                                        {% endif %}>

                                    {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}
                                        <!-- ê²½ë§¤ ìƒí’ˆì´ë©´ í˜„ì¬ ìƒíƒœë§Œ í‘œì‹œ -->
                                        <option value="{{ product.listing_status }}" selected>{{ product.listing_status }}</option>
                                    {% else %}
                                        <!-- ì¼ë°˜ ìƒí’ˆì´ë©´ í˜„ì¬ ìƒíƒœì™€ íŒë§¤ ì˜µì…˜ í‘œì‹œ -->
                                        {% for stat in ['íŒë§¤ì¤‘', 'í’ˆì ˆ'] %}
                                            <option value="{{ stat }}" {% if product.listing_status == stat %}selected{% endif %}>{{ stat }}</option>
                                        {% endfor %}
                                    {% endif %}

                                </select>

                                <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %}
                                    <small style="display: block; color: #dc3545; margin-top: 5px; font-size: 0.8em;">
                                        âš ï¸ ê²½ë§¤ ìƒí’ˆì€ ìƒíƒœ ë³€ê²½ ë¶ˆê°€
                                    </small>
                                {% endif %}

                                {% if product.stock == 0 and product.listing_status == 'íŒë§¤ì¤‘' %}
                                    <small style="display: block; color: #dc3545; margin-top: 5px; font-size: 0.8em;">
                                        âš ï¸ íŒë§¤ì¤‘ì¸ ìƒí’ˆì˜ ì¬ê³ ëŠ” 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                <!--ì»¨ë””ì…˜ Input (Resellerë§Œ í™œì„±í™”) -->
                                    <select class="form-control condition-select" {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] or user_profile.user.role != 'Reseller' %}disabled{% endif %}>
                                        <option value="ë¯¸ê°œë´‰" {% if product.condition == 'ë¯¸ê°œë´‰' %}selected{% endif %}>ë¯¸ê°œë´‰ (S)</option>
                                        <option value="ìµœìƒ" {% if product.condition == 'ìµœìƒ' %}selected{% endif %}>ìµœìƒ (A)</option>
                                        <option value="ì¤‘" {% if product.condition == 'ì¤‘' %}selected{% endif %}>ì¤‘ (B)</option>
                                        <option value="í•˜" {% if product.condition == 'í•˜' %}selected{% endif %}>í•˜ (C)</option>
                                    </select>
                            </td>
                            <td>
                                <!-- ì €ì¥ ë²„íŠ¼ (onclick ì´ë²¤íŠ¸ ì—°ê²°) -->
                                <button class="btn primary-btn" onclick="saveProductUpdate({{ product.listing_id }})"
                                {% if product.listing_status in ['ê²½ë§¤ ì˜ˆì •', 'ê²½ë§¤ ì¤‘', 'íŒë§¤ ì¢…ë£Œ'] %} disabled style="background-color:#999; cursor:not-allowed;"
                                {% endif %}>ì €ì¥</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>ë“±ë¡í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. <a href="{{ url_for('show_product_register_page') }}">ìƒí’ˆì„ ë“±ë¡</a>í•´ë³´ì„¸ìš”.</p>
            {% endif %}

            <!-- ë‹¤ì€ TODO: styleëº´ê¸°. -->
            <style>
                .form-control {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                }
                .order-history-table td {
                    vertical-align: middle;
                    min-width: 120px;
                }
                .order-history-table td input[type="number"] {
                    width: 80px;
                }
            </style>

            {% elif view == 'sales' %}
            <h3>ğŸ’° íŒë§¤ ë‚´ì—­(ì£¼ë¬¸ ë‚´ì—­)</h3>
                <!--íŒë§¤ ë‚´ì—­(Seller)-->
                {% if sales_orders %}
                    <p>ì´ {{ sales_orders | length }}ê±´ì˜ íŒë§¤ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <table class="order-history-table">
                        <thead>
                            <tr>
                                <th>ìƒí’ˆ ì •ë³´</th>
                                <th>êµ¬ë§¤ì</th>
                                <th>ì£¼ì†Œ</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ì´ ê¸ˆì•¡</th>
                                <th>ì£¼ë¬¸ ì¼ì‹œ</th>
                                <th>ì²˜ë¦¬ ìƒíƒœ</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in sales_orders %}
                            <tr data-order-id="{{ order.order_id }}">
                                <td>
                                    <a href="{{ url_for('show_product_detail', listing_id=order.listing_id) }}">
                                        <img src="{{ order.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ order.product_name }}" width="40" height="40" style="margin-right: 10px; border-radius: 4px; vertical-align: middle;">
                                        {{ order.product_name }}
                                    </a>
                                </td>
                                <td>{{ order.buyer_name }} ({{ order.buyer_uid }})</td>
                                <td>{{ order.buyer_address }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>{{ "{:,.0f}ì›".format(order.total_price) }}</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="order-status-{{ order.order_id }}">{{ order.status }}</td>
                                <td>
                                    <!--  ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ë²„íŠ¼ (í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°) -->
                                    <button class="btn update-status-btn"
                                            data-order-id="{{ order.order_id }}"
                                            data-current-status="{{ order.status }}"
                                            {% if order.status in ['ë°°ì†¡ ì™„ë£Œ', 'í™˜ë¶ˆ', 'êµí™˜'] %} disabled {% endif %}
                                            style="{% if order.status == 'ë°°ì†¡ ì¤‘' %} background-color: orange; {% elif order.status == 'ìƒí’ˆ ì¤€ë¹„ì¤‘' %} background-color: #007bff; {% else %} background-color: #6c757d; {% endif %} color: white; border: none; padding: 5px 10px; border-radius: 4px;">
                                        {{ 'ë°°ì†¡ ì²˜ë¦¬' if order.status == 'ìƒí’ˆ ì¤€ë¹„ì¤‘' else 'ì¶œê³  ì™„ë£Œ' if order.status == 'ë°°ì†¡ ì¤‘' else 'ìƒíƒœ ë³€ê²½ ë¶ˆê°€' }}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>ìµœê·¼ íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            {% elif view == 'disputes' %}
            <!-- TODO: ë¶„ìŸ ì²˜ë¦¬ í˜„í™© (Buyer) -->
            <h3>ğŸ“ ë¶„ìŸ ì²˜ë¦¬ í˜„í™©</h3>
                {% if disputes %}
                <p>ì´ {{ disputes | length }}ê±´ì˜ ë¶„ìŸ ìš”ì²­ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.</p>

                <table class="order-history-table">
                    <thead>
                        <tr>
                            <th>ìš”ì²­ ID</th>
                            <th>ìš”ì²­ ìœ í˜•</th>
                            <th>ìš”ì²­ ìƒí’ˆ</th>
                            <th>íŒë§¤ì</th>
                            <th>ì£¼ë¬¸ ìƒíƒœ</th>
                            <th>ì²˜ë¦¬ ìƒíƒœ</th>
                            <th>ì‚¬ìœ </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dispute in disputes %}
                        <tr>
                            <td>{{ dispute.dispute_id }}</td>
                            <td><span class="issue-type issue-{{ dispute.issue_type }}">{{ dispute.issue_type }}</span></td>
                            <td>{{ dispute.product_name }}</td>
                            <td>{{ dispute.seller_name }}</td>
                            <td>{{ dispute.order_status }}</td>

                            <td><span class="dispute-status status-{{ dispute.dispute_status | lower | replace(' ', '') }}">{{ dispute.dispute_status }}</span></td>
                            <td>{{ dispute.reason }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>í˜„ì¬ ì ‘ìˆ˜ëœ ë¶„ìŸ ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}

            {% elif view == 'feedback' %}
            <h3>â­ í›„ê¸° ì‘ì„±í•˜ê¸°</h3>
            <h5>ë°°ì†¡ ì™„ë£Œëœ ìƒí’ˆì— ëŒ€í•´ í›„ê¸°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</h5>
                {% if finished_orders%}
                    <p>ì´ {{ finished_orders | length }}ê±´ì˜ ì™„ë£Œëœ ì£¼ë¬¸ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <table class="order-history-table">
                        <thead>
                            <tr>
                                <th>ì£¼ë¬¸ ìƒí’ˆ</th>
                                <th>íŒë§¤ì</th>
                                <th>ì£¼ë¬¸ ì¼ì‹œ</th>
                                <th>ë³„ì </th>
                                <th>ì½”ë©˜íŠ¸</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in finished_orders %}
                            {% set is_completed = order.feedback_submitted %}
                            {% set disabled_attr = 'disabled' if is_completed else '' %}

                            {% set current_rating = order.feedback_rating | default(5) %}
                            {% set current_comment = order.feedback_comment | default('') %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('show_product_detail', listing_id=order.listing_id) }}">
                                        <img src="{{ order.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}" alt="{{ order.product_name }}" width="40" height="40" style="margin-right: 10px; border-radius: 4px; vertical-align: middle;">
                                        {{ order.product_name }}
                                    </a>
                                </td>
                                <td>{{ order.seller_name }}</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <select class="form-control feedback-select" {{ disabled_attr }} >
                                        {% for option_value in [5, 4, 3, 2, 1] %}
                                            <option value="{{ option_value }}" {% if current_rating == option_value %}selected{% endif %}>
                                                {{ option_value }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input
                                        type="text"
                                        class="form-control feedback-comment-input"
                                        placeholder="í›„ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (í•„ìˆ˜)"
                                        value="{{current_comment}}"
                                        {{ disabled_attr }}
                                    >
                                </td>
                                <td>
                                    {% if is_completed %}
                                        <span style="color: green; font-weight: bold;">âœ… ì‘ì„± ì™„ë£Œ</span>
                                    {% else %}
                                        <button class="btn feedback-btn btn-feedback" onclick="submitFeedback({{ order.order_id }},{{order.seller_id}}, this)">
                                            í›„ê¸° ì—…ë¡œë“œí•˜ê¸°
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>ì™„ë£Œëœ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}


            {% elif view == 'profile' %}
            <h3>ğŸ‘¤ íšŒì› ì •ë³´ ìˆ˜ì •</h3>
            <p class="subtitle">í•„ìš”í•œ í•­ëª©ë§Œ ì…ë ¥í•˜ê³  ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            <div class="form-container wide" style="margin: 0 auto; box-shadow: none; border: none;">
                <form id="profile-update-form">
                    <!-- ê³µí†µ ì •ë³´ -->
                    <div class="form-group-section">
                        <h3>ê¸°ë³¸ ê³„ì • ì •ë³´</h3>
                        <div class="form-group">
                            <label for="uid">ì•„ì´ë”” (ë¡œê·¸ì¸ ID)</label>
                            <!-- user_uidëŠ” ìˆ˜ì • ë¶ˆê°€ -->
                            <input type="text" id="uid" value="{{ user_profile.user.user_uid }}" disabled style="background-color: #f5f5f5;">
                        </div>

                        <div class="form-group">
                            <label for="name">ì´ë¦„/í™œë™ëª…</label>
                            <input type="text" id="name" name="name" value="{{ user_profile.user.name }}" required>
                            <p class="note">í˜„ì¬ ì´ë¦„: <strong>{{ user_profile.user.name }}</strong></p>
                        </div>

                        <div class="form-group">
                            <label for="password">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label>
                            <input type="password" id="password" name="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¯¸ì…ë ¥ ì‹œ ë³€ê²½ ì•ˆ í•¨)">
                        </div>
                    </div>
                    <hr>
                    <!-- ì—­í• ë³„ ì •ë³´ -->
                    {% if user_profile.user.role == 'Buyer' %}
                    <div class="form-group-section">
                        <h3>ë°°ì†¡ ì •ë³´ (êµ¬ë§¤ì ì „ìš©)</h3>
                        <div class="form-group">
                            <label for="address">ê¸°ë³¸ ë°°ì†¡ ì£¼ì†Œ</label>
                            <input type="text" id="address" name="address"
                                   value="{{ user_profile.buyer_profile.address | default('') }}"
                                   placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
                        </div>
                    </div>

                    {% elif user_profile.user.role in ['PrimarySeller', 'Reseller'] %}
                    <div class="form-group-section">
                        <h3>íŒë§¤ì ì •ë³´</h3>
                        <div class="form-group">
                            <label for="store_name">ìƒì ëª… (Seller ì „ìš©)</label>
                            <input type="text" id="store_name" name="store_name"
                                   value="{{ user_profile.seller_profile.store_name | default('') }}"
                                   placeholder="ìƒì ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>

                    {% elif user_profile.user.role == 'Administrator' %}
                    <div class="form-group-section">
                        <h3>ê´€ë¦¬ì ê³„ì •</h3>
                        <p class="note" style="color: green;">ê´€ë¦¬ì ê³„ì •ì€ ì´ë¦„/ë¹„ë°€ë²ˆí˜¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    {% endif %}

                    <button type="submit" class="btn full-width submit-btn" style="margin-top: 30px;">ì •ë³´ ìˆ˜ì • ì™„ë£Œ</button>
                    <div id="api-message" class="message-box" style="margin-top: 15px;"></div>
                </form>
            </div>
            {% elif view == 'admin_rating' %}
            <h3>ğŸ’ êµ¿ì¦ˆ ë“±ê¸‰ ë¶€ì—¬</h3>
            <!-- êµ¿ì¦ˆ ë“±ê¸‰ ë¶€ì—¬ ê¸°ëŠ¥ êµ¬í˜„ (admin)-->
            <div id="admin-update-message" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; display: none;">
                ì—¬ê¸°ì— ì—…ë°ì´íŠ¸ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
           {% if products %}
                <p>ì´ {{ products | length }}ê±´ì˜ ë“±ë¡ëœ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤.</p>
                <table class="order-history-table">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆ ì •ë³´ (ì´ë¦„)</th>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>ìƒí’ˆ ì„¤ëª…</th>
                            <th>ë“±ë¡ëœ ë™ì¼ ìƒí’ˆ ìˆ˜</th>
                            <th>ë“±ê¸‰ (ì¸ê¸°ë„)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                            <!--JavaScriptê°€ í–‰(row)ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ID ë¶€ì—¬ -->
                            <tr id="row-{{ product.product_id }}">
                                <!-- Product IDë¥¼ ìˆ¨ê²¨ë‘  (ì—…ë°ì´íŠ¸ ì‹œ í•„ìš”) -->
                                <input type="hidden" class="product-id-input" value="{{ product.product_id }}">
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <img src="{{ product.image_url | default('https://placehold.co/60x60/eee/ccc?text=Goods', true) }}"
                                             alt="{{ product.product_name }}"
                                             width="40"
                                             height="40"
                                             style="margin-right: 10px; border-radius: 4px;">
                                    </div>
                                    {{product.name}}
                                </td>
                                <td>
                                    {{product.category}}
                                </td>
                                <td>
                                    {{product.description}}
                                </td>
                                <td>
                                    {{product.product_count}}
                                </td>
                              <td data-field="listing_status" class="editable-cell">
                                    {% set current_rating = product.rating | default('null') %}
                                    <select class="form-control rating-select" data-current-value="{{ current_rating }}">
                                        <option value="-" {% if current_rating == 'null' %}selected{% endif %}> - </option>
                                        <option value="S" {% if current_rating == 'S' %}selected{% endif %}> S </option>
                                        <option value="A" {% if current_rating == 'A' %}selected{% endif %}> A </option>
                                        <option value="B" {% if current_rating == 'B' %}selected{% endif %}> B </option>
                                        <option value="C" {% if current_rating == 'C' %}selected{% endif %}> C </option>
                                    </select>
                                </td>
                                <td>
                                    <!-- ì €ì¥ ë²„íŠ¼ (onclick ì´ë²¤íŠ¸ ì—°ê²°) -->
                                    <button class="btn primary-btn" onclick="saveAdminProductRating({{ product.product_id }})">ì €ì¥</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>ë“±ë¡í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            {% elif view == 'admin_disputes' %}
            <h3>ğŸ“ ë¶„ìŸ ì¡°ì • ë° ê´€ë¦¬</h3>
            <p class="subtitle">êµ¬ë§¤ìì™€ íŒë§¤ì ê°„ì˜ í™˜ë¶ˆ/êµí™˜ ìš”ì²­ì„ ì‹¬ì‚¬í•˜ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>

            <div id="dispute-message" style="margin: 15px 0; padding: 10px; border-radius: 6px; display: none; font-weight: bold; text-align: center;"></div>

            {% if admin_disputes %}
                <p>ì´ {{ admin_disputes | length }}ê±´ì˜ ë¶„ìŸ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤.</p>

                <table class="dispute-table order-history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ìœ í˜•</th>
                            <th>ìš”ì²­ ìƒí’ˆ</th>
                            <th>êµ¬ë§¤ì / íŒë§¤ì</th>
                            <th>ìš”ì²­ ì‚¬ìœ </th>
                            <th>í˜„ì¬ ìƒíƒœ</th>
                            <th>ì£¼ë¬¸ ìƒíƒœ</th>
                            <th>ì²˜ë¦¬ ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dispute in admin_disputes %}
                        <tr data-dispute-id="{{ dispute.dispute_id }}">
                            <td>{{ dispute.dispute_id }}</td>
                            <td><span class="issue-type issue-{{ dispute.issue_type | lower }}">{{ dispute.issue_type }}</span></td>
                            <td>{{ dispute.product_name }}</td>
                            <td>{{ dispute.buyer_name }} / {{ dispute.seller_name }}</td>
                            <td style="max-width: 250px; text-align: left; font-size: 0.85em;">{{ dispute.reason | default('ì‚¬ìœ  ì—†ìŒ') }}</td>

                            <td><span class="dispute-status status-{{ dispute.status | lower | replace(' ', '') }}">{{ dispute.status }}</span></td>
                            <td>{{ dispute.order_status }}</td>

                            <td class="action-cell">
                                {% if dispute.status == 'ì²˜ë¦¬ ì „' %}
                                <button class="btn admin-action-btn btn-processing" onclick="updateAdminDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì¤‘', null)">
                                    ì²˜ë¦¬ ì‹œì‘
                                </button>
                                {% elif dispute.status == 'ì²˜ë¦¬ ì¤‘' %}
                                    <div class="dispute-resolve-group">
                                        <button class="btn admin-action-btn btn-refund" onclick="updateAdminDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì™„ë£Œ', 'í™˜ë¶ˆ')">
                                            í™˜ë¶ˆ ìŠ¹ì¸
                                        </button>
                                        <button class="btn admin-action-btn btn-exchange" onclick="updateAdminDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì™„ë£Œ', 'êµí™˜')">
                                            êµí™˜ ìŠ¹ì¸
                                        </button>
                                        <button class="btn admin-action-btn btn-reject" onclick="updateAdminDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì™„ë£Œ', 'ê±°ì ˆ')">
                                            ìš”ì²­ ê±°ì ˆ
                                        </button>
                                    </div>
                                {% else %}
                                    - ({{ dispute.status }})
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            {% else %}
                <p>í˜„ì¬ ì ‘ìˆ˜ëœ ë¶„ìŸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
            {% elif view == 'admin_seller_eval' %}
            <h3>ğŸ† íŒë§¤ì í‰ê°€ ê´€ë¦¬</h3>
<!--            TODO: íŒë§¤ì í‰ê°€ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„(admin)-->
                {% if all_feedback%}
                    <p>ì´ {{ all_feedback | length }}ê±´ì˜ í›„ê¸°ë“¤ì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <table class="order-history-table">
                        <thead>
                            <tr>
                                <th>ì£¼ë¬¸ ë²ˆí˜¸</th>
                                <th>íŒë§¤ì</th>
                                <th>ë³„ì </th>
                                <th>ì½”ë©˜íŠ¸</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feedback in all_feedback %}
                            {% set is_completed = feedback.is_checked %}
                            {% set disabled_attr = 'disabled' if is_completed else '' %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('show_product_detail', listing_id=feedback.listing_id) }}">
                                        {{ feedback.order_id }}
                                    </a>
                                </td>
                                <td>{{ feedback.seller_name }}</td>
                                <td>{{feedback.rating}}</td>
                                <td>{{feedback.comment}}</td>
                                <td>
                                    {% if is_completed %}
                                        <span style="color: green; font-weight: bold;">âœ… í™•ì¸ ì™„ë£Œ</span>
                                    {% else %}
                                        <button class="btn feedback-btn btn-feedback" onclick="CheckFeedback({{feedback.feedback_id}},{{ feedback.order_id }},{{feedback.target_seller_id}}, this)">
                                            ìŠ¹ì¸
                                        </button>
                                        <button class="btn feedback-btn btn-feedback" onclick="RejectFeedback({{feedback.feedback_id}},{{ feedback.order_id }},{{feedback.target_seller_id}}, this)">
                                            ê±°ì ˆ
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>ì‘ì„±ëœ íŒë§¤ì í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}

            {% endif %}


            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // ë§ˆì´í˜ì´ì§€ íŒë§¤ì ì£¼ë¬¸ ë‚´ì—­ì—ì„œë§Œ ì‹¤í–‰
                    const updateStatusBtns = document.querySelectorAll('.update-status-btn');

                    const getNextStatusInfo = (currentStatus) => {
                        if (currentStatus === 'ìƒí’ˆ ì¤€ë¹„ì¤‘') {
                            return { next: 'ë°°ì†¡ ì¤‘', confirmMsg: 'ì£¼ë¬¸ ìƒíƒœë¥¼ [ë°°ì†¡ ì¤‘]ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' };
                        } else if (currentStatus === 'ë°°ì†¡ ì¤‘') {
                            return { next: 'ë°°ì†¡ ì™„ë£Œ', confirmMsg: 'ì£¼ë¬¸ ìƒíƒœë¥¼ [ë°°ì†¡ ì™„ë£Œ]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' };
                        }
                        return null; // ë³€ê²½ ë¶ˆê°€ëŠ¥ ìƒíƒœ
                    };

                    updateStatusBtns.forEach(button => {
                        button.addEventListener('click', async function() {
                            const orderId = this.getAttribute('data-order-id');
                            const currentStatus = this.getAttribute('data-current-status');
                            const statusInfo = getNextStatusInfo(currentStatus);

                            if (!statusInfo) {
                                alert(`ì£¼ë¬¸ ìƒíƒœ '${currentStatus}'ëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                                return;
                            }

                            if (!confirm(statusInfo.confirmMsg)) {
                                return;
                            }

                            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
                            this.disabled = true;
                            this.textContent = 'ì²˜ë¦¬ ì¤‘...';

                            try {
                                const response = await fetch('/api/order/update_status', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ order_id: orderId })
                                });

                                const result = await response.json();
                                const statusCell = document.querySelector(`.order-status-${orderId}`);

                                if (response.ok) {
                                    const newStatus = result.new_status;
                                    alert(`ìƒíƒœ ë³€ê²½ ì„±ê³µ: ${newStatus}`);

                                    // UI ì—…ë°ì´íŠ¸
                                    statusCell.textContent = newStatus;
                                    this.setAttribute('data-current-status', newStatus);

                                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ìƒíƒœë¥¼ ìœ„í•œ ì¤€ë¹„)
                                    if (newStatus === 'ë°°ì†¡ ì¤‘') {
                                        this.textContent = 'ì¶œê³  ì™„ë£Œ';
                                        this.style.backgroundColor = 'orange';
                                        this.disabled = false; // ë‹¤ìŒ ìƒíƒœë¡œì˜ ë³€ê²½ í—ˆìš©
                                    } else if (newStatus === 'ë°°ì†¡ ì™„ë£Œ') {
                                        this.textContent = 'ìƒíƒœ ë³€ê²½ ë¶ˆê°€';
                                        this.style.backgroundColor = '#6c757d';
                                        this.disabled = true; // ìµœì¢… ìƒíƒœì´ë¯€ë¡œ ë¹„í™œì„±í™”
                                    }
                                } else {
                                    alert(`ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${result.error || result.message}`);
                                    // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë¡¤ë°±
                                    this.textContent = currentStatus === 'ìƒí’ˆ ì¤€ë¹„ì¤‘' ? 'ë°°ì†¡ ì²˜ë¦¬' : 'ì¶œê³  ì™„ë£Œ';
                                    this.disabled = false;
                                }

                            } catch (error) {
                                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë¡¤ë°±
                                this.textContent = currentStatus === 'ìƒí’ˆ ì¤€ë¹„ì¤‘' ? 'ë°°ì†¡ ì²˜ë¦¬' : 'ì¶œê³  ì™„ë£Œ';
                                this.disabled = false;
                            }
                        });
                    });
                });
                // êµ¬ë§¤ í™•ì • ë²„íŠ¼ ê´€ë ¨
                async function confirmPurchase(orderId) {
                    if (!confirm(`ì£¼ë¬¸ #${orderId}ì˜ êµ¬ë§¤ë¥¼ ìµœì¢… í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í™˜ë¶ˆ/êµí™˜ ìš”ì²­ ë¶ˆê°€)`)) {
                        return;
                    }

                    const apiUrl = '/api/order/confirm_purchase';
                    const data = { order_id: orderId };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert(result.message);
                            // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ UI (ë²„íŠ¼)ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
                            window.location.reload();
                        } else {
                            alert(`êµ¬ë§¤ í™•ì • ì‹¤íŒ¨: ${result.error || result.message}`);
                        }

                    } catch (error) {
                        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ êµ¬ë§¤ í™•ì • ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                }
                //ë¶„ìŸ ì²˜ë¦¬ ê´€ë ¨ JSë¡œì§
                function showDisputeModal(orderId, issueType) {
                    const reason = prompt(`ì£¼ë¬¸ #${orderId}ì— ëŒ€í•œ ${issueType} ìš”ì²­ ì‚¬ìœ ë¥¼ ê°„ë‹¨íˆ ì…ë ¥í•´ì£¼ì„¸ìš”:`);

                    // ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ëˆŒë €ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì¼ ê²½ìš°
                    if (!reason || reason.trim() === '') {
                        if (reason !== null) {
                            alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ ë¶„ìŸì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                        }
                        return;
                    }

                    // ë¶„ìŸ API í˜¸ì¶œ
                    requestDispute(orderId, issueType, reason.trim());
                }
                async function requestDispute(orderId, issueType, reason) {
                    const data = {
                        order_id: orderId,
                        issue_type: issueType,
                        reason: reason
                    };

                    try {
                        const response = await fetch('/api/dispute/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert(result.message);
                            // ìš”ì²­ ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë²„íŠ¼ ë¹„í™œì„±í™” (ì„ íƒì )
                            window.location.reload();
                        } else {
                            alert(`ë¶„ìŸ ìš”ì²­ ì‹¤íŒ¨: ${result.error || result.message}`);
                        }

                    } catch (error) {
                        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë¶„ìŸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                }
                async function updateAdminDisputeStatus(disputeId, newStatus, resolution) {
                    const messageDiv = document.getElementById('dispute-message');

                    // ê²½ê³ ì°½ í™•ì¸
                    if (newStatus === 'ì²˜ë¦¬ ì™„ë£Œ') {
                        let action = resolution === 'ê±°ì ˆ' ? 'ê±°ì ˆ' : `${resolution} ìŠ¹ì¸`;
                        if (!confirm(`ë¶„ìŸ #${disputeId}ì— ëŒ€í•´ [${action}] ì²˜ë¦¬ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)`)) {
                            return;
                        }
                    } else if (newStatus === 'ì²˜ë¦¬ ì¤‘' && !confirm(`ë¶„ìŸ #${disputeId}ì˜ ì²˜ë¦¬ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }

                    const data = {
                        dispute_id: disputeId,
                        new_status: newStatus,
                        resolution: resolution
                    };

                    messageDiv.textContent = 'ì²˜ë¦¬ ì¤‘...';
                    messageDiv.style.color = 'blue';
                    messageDiv.style.display = 'block';

                    try {
                        const response = await fetch('/api/dispute/update_status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            messageDiv.textContent = `âœ… ${result.message}`;
                            messageDiv.style.color = '#2ecc71';
                            // ìƒíƒœ ì—…ë°ì´íŠ¸ ë°˜ì˜ì„ ìœ„í•´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);

                        } else {
                            const errorMessage = result.error || result.message;

                            if (errorMessage === "ë…¼ë¦¬ì  ì˜¤ë¥˜") {
                                // ë°±ì—”ë“œì—ì„œ ë°˜í™˜ëœ ìƒì„¸ ë©”ì‹œì§€ë¥¼ alertë¡œ ë„ì›Œ ê´€ë¦¬ìì—ê²Œ ì¬í™•ì¸ ìš”êµ¬
                                alert(result.message);
                            } else {
                                 // ì¼ë°˜ì ì¸ DB ë˜ëŠ” API ì˜¤ë¥˜ ì²˜ë¦¬
                                 alert(`âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${errorMessage}`);
                            }
                            messageDiv.textContent = `âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${result.error || result.message}`;
                            messageDiv.style.color = '#dc3545';
                        }
                    } catch (error) {
                        messageDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬ ì‹¤íŒ¨';
                        messageDiv.style.color = '#dc3545';
                    }
                }
                //ê°œì¸ ì •ë³´ ìˆ˜ì • ê´€ë ¨ ë¡œì§
                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.getElementById('profile-update-form');
                    const messageArea = document.getElementById('api-message');

                    form.addEventListener('submit', async function(event) {
                        event.preventDefault();

                        messageArea.textContent = 'ì •ë³´ ìˆ˜ì • ìš”ì²­ ì¤‘...';
                        messageArea.style.color = 'gray';

                        const formData = new FormData(form);
                        const data = {
                            password: formData.get('password'),
                            name: formData.get('name'),
                        };

                        // ì—­í• ë³„ í•„ë“œ ì¶”ê°€
                        if (formData.has('address')) {
                            data.address = formData.get('address');
                        }
                        if (formData.has('store_name')) {
                            data.store_name = formData.get('store_name');
                        }

                        try {
                            const response = await fetch('/api/mypage/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });

                            const result = await response.json();

                            if (response.ok) {
                                messageArea.textContent = result.message;
                                messageArea.style.color = '#2ecc71'; // ì„±ê³µ ìƒ‰ìƒ
                                // ìˆ˜ì • ì„±ê³µ í›„ ì„¸ì…˜ ì •ë³´ ê°±ì‹ ì„ ìœ„í•´ ë§ˆì´í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ë·°ëŠ” profile ìœ ì§€)
                                setTimeout(() => {
                                    window.location.href = '{{ url_for("show_mypage", view="profile") }}';
                                }, 1500);
                            } else {
                                messageArea.textContent = `ìˆ˜ì • ì‹¤íŒ¨: ${result.error || result.message}`;
                                messageArea.style.color = '#dc3545'; // ì‹¤íŒ¨ ìƒ‰ìƒ
                            }

                        } catch (error) {
                            messageArea.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                            messageArea.style.color = '#dc3545';
                        }
                    });
                });

                // ìƒí’ˆ ì •ë³´ ìˆ˜ì • (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
                async function saveProductUpdate(listingId) {
                    const row = document.getElementById('row-' + listingId);
                    const messageArea = document.getElementById('update-message-area');

                    if (!row) {
                        alert("ì˜¤ë¥˜: í•´ë‹¹ ìƒí’ˆ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // 1. í–‰(row) ë‚´ë¶€ì—ì„œ ìˆ˜ì •ëœ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
                    const data = {
                        listing_id: listingId,
                        product_id: row.querySelector('.product-id-input').value,
                        product_name: row.querySelector('.product-name-input').value,
                        category: row.querySelector('.category-select').value,
                        price: row.querySelector('.price-input').value,
                        stock: row.querySelector('.stock-input').value,
                        listing_status: row.querySelector('.status-select').value,
                        condition: row.querySelector('.condition-select').value
                    };

                    messageArea.textContent = `ìƒí’ˆ(ID: ${listingId}) ì €ì¥ ì¤‘...`;
                    messageArea.style.color = 'blue';
                    messageArea.style.display = 'block';

                    try {
                        // 2. /api/seller/product/update API í˜¸ì¶œ
                        const response = await fetch('/api/seller/product/update', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            messageArea.textContent = `âœ… ${result.message}`;
                            messageArea.style.color = 'green';
                        } else {
                            messageArea.textContent = `âŒ ì €ì¥ ì‹¤íŒ¨: ${result.error || result.message}`;
                            messageArea.style.color = 'red';
                        }

                    } catch (error) {
                        messageArea.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                        messageArea.style.color = 'red';
                    }

                    // 3ì´ˆ ë’¤ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        messageArea.style.display = 'none';
                    }, 3000);
                }
                document.addEventListener("DOMContentLoaded", () => {
                    document.querySelectorAll(".status-select").forEach(select => {
                        select.addEventListener("change", function() {
                            const row = select.closest("tr");
                            const stock = row.querySelector(".stock-input").value;

                            // ì¬ê³ =0 ì´ë©´ì„œ ìƒíƒœ=íŒë§¤ì¤‘ì¸ ê²½ìš° ë°©ì§€
                            if (this.value === "íŒë§¤ì¤‘" && parseInt(stock) === 0) {
                                alert("ì¬ê³ ê°€ 0ê°œì¸ ìƒí’ˆì€ 'íŒë§¤ì¤‘' ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                                this.value = "í’ˆì ˆ";   // ìë™ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
                            }
                        });
                    });
                });

                document.querySelectorAll(".stock-input").forEach(input => {
                    input.addEventListener("input", function () {
                        const row = input.closest("tr");
                        const statusSelect = row.querySelector(".status-select");

                        if (parseInt(this.value) === 0 && statusSelect.value === "íŒë§¤ì¤‘") {
                            statusSelect.value = "í’ˆì ˆ";
                        }
                    });
                });
                   //ìƒí’ˆ ë“±ê¸‰ ìˆ˜ì •
                async function saveAdminProductRating(productId) {
                console.log("DEBUG: saveAdminProductRating í•¨ìˆ˜ í˜¸ì¶œë¨. Product ID:", productId);
                    const row = document.getElementById('row-' + productId);
                    const messageArea = document.getElementById('admin-update-message');

                    if (!row) return;

                    // ë“±ê¸‰ ê°’ ê°€ì ¸ì˜¤ê¸°
                    const ratingSelect = row.querySelector('.rating-select');
                    const rating = ratingSelect.value;

                    messageArea.textContent = `ìƒí’ˆ(ID: ${productId}) ë“±ê¸‰ ì €ì¥ ì¤‘...`;
                    messageArea.style.color = 'blue';
                    messageArea.style.display = 'block';

                    try {
                        // (â˜…) ê´€ë¦¬ì ì „ìš© API í˜¸ì¶œ
                        const response = await fetch('/api/admin/product/update', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: productId, rating: rating })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            messageArea.textContent = `âœ… ${result.message}`;
                            messageArea.style.color = 'green';
                        } else {
                            messageArea.textContent = `âŒ ì €ì¥ ì‹¤íŒ¨: ${result.error || result.message}`;
                            messageArea.style.color = 'red';
                        }

                    } catch (error) {
                        messageArea.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                        messageArea.style.color = 'red';
                    }

                    setTimeout(() => { messageArea.style.display = 'none'; }, 3000);
                }

    // //////////////////////í”¼ë“œë°± ê´€ë ¨ ë¡œì§ /////////////////////////////////
    // ///////////////////////////////////////////////////////////////////////
                //êµ¬ë§¤ì í›„ê¸° ì‘ì„± ë¡œì§
                async function submitFeedback(order_id, target_seller_id, button_element) {

                    // 1. ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘
                    const row = button_element.closest('tr');
                    const ratingElement = row.querySelector('.feedback-select');
                    const rating = parseInt(ratingElement.value);

                    const commentElement = row.querySelector('.feedback-comment-input');
                    const comment = commentElement.value;

                    if (comment.trim() === '') {
                        alert("ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    const feedbackData = {
                        order_id: order_id,
                        target_seller_id: target_seller_id,
                        rating: rating,
                        comment: comment
                    };

                    try {
                        // 3. Flask API í˜¸ì¶œ
                        const response = await fetch('/api/buyer/submit_feedback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(feedbackData)
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            // 4. API ì‹¤íŒ¨ ì²˜ë¦¬ (400, 409 ë“± ì˜¤ë¥˜)
                            alert("í›„ê¸° ì‘ì„± ì‹¤íŒ¨: " + (result.error || result.message));
                            button_element.textContent = 'ì¬ì‹œë„';
                            button_element.disabled = false;
                            return;
                        }

                        // 5. ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
                        alert(result.message);

                        // ì‘ì„± ì™„ë£Œëœ í–‰ì„ ë¹„í™œì„±í™” ì²˜ë¦¬, UI ì¦‰ì‹œ ë³€ê²½
                        row.style.backgroundColor = '#e0ffe0';
                        button_element.textContent = 'ì‘ì„± ì™„ë£Œ';
                        button_element.disabled = true;
                        ratingElement.disabled = true;
                        commentElement.disabled = true;

                    } catch (error) {
                        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì²˜ë¦¬
                        alert("í›„ê¸° ì‘ì„± ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        button_element.textContent = 'ì˜¤ë¥˜';
                        button_element.disabled = false;
                    }
                }

                //ê´€ë¦¬ìì˜ í”¼ë“œë°± ìŠ¹ì¸ ì²˜ë¦¬
                async function callFeedbackAPI(feedback_id, order_id, seller_id, action, button_element) {
                    button_element.disabled = true;
                    const originalText = button_element.textContent;
                    button_element.textContent = 'ì²˜ë¦¬ ì¤‘...';

                    const requestData = {
                        feedback_id: feedback_id,
                        order_id: order_id,
                        seller_id: seller_id,
                        action: action
                    };

                    try {
                        const response = await fetch('/api/admin/feedback/process', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + (result.error || result.message));
                            button_element.textContent = 'ì‹¤íŒ¨';
                            button_element.style.backgroundColor = 'red';
                            button_element.disabled = false;
                            return;
                        }

                        // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
                        alert(result.message);
                        const row = button_element.closest('tr');

                        if (action === 'approve') {
                            // ìŠ¹ì¸ ì‹œ: ë²„íŠ¼ì„ 'í™•ì¸ ì™„ë£Œ' ìƒíƒœë¡œ ë³€ê²½
                            row.cells[4].innerHTML = '<span style="color: green; font-weight: bold;">âœ… í™•ì¸ ì™„ë£Œ</span>';
                            row.style.backgroundColor = '#f0fff0'; // ë°ì€ ë…¹ìƒ‰ ë°°ê²½
                        } else if (action === 'reject') {
                            // ê±°ì ˆ ì‹œ: í–‰ì„ í…Œì´ë¸”ì—ì„œ ì œê±°
                            row.remove();
                        }
                    } catch (error) {
                        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        button_element.textContent = originalText;
                        button_element.disabled = false;
                    }
                }
                window.CheckFeedback = function(feedback_id, order_id, seller_id, button_element) {
                    if (confirm("ì´ í›„ê¸°ë¥¼ ìŠ¹ì¸í•˜ê³  íŒë§¤ì í‰ê°€ì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        callFeedbackAPI(feedback_id, order_id, seller_id, 'approve', button_element);
                    }
                };

                window.RejectFeedback = function(feedback_id, order_id, seller_id, button_element) {
                    if (confirm("ì´ í›„ê¸°ë¥¼ ê±°ì ˆí•˜ê³  ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í†µê³„ ë¯¸ë°˜ì˜)")) {
                        callFeedbackAPI(feedback_id, order_id, seller_id, 'reject', button_element);
                    }
                };
            </script>
        </div>
    </div>
{% endblock %}