{% extends "base.html" %}

{% block title %}ë¶„ìŸ ì¡°ì • | ì…€ë ‰íŠ¸ ë§ˆì¼“{% endblock %}

{% block content %}
    
    <h2>ğŸ“‹ ë¶„ìŸ ì¡°ì • ë° ê´€ë¦¬</h2>
    
    {% include 'includes/admin_nav.html' %} 

    <div class="dispute-container">
        
        <h3>ë¯¸ì²˜ë¦¬ ë¶„ìŸ ëª©ë¡ (ì´ {{ disputes | length }}ê±´)</h3>
        
        <table class="dispute-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ìš”ì²­ ìœ í˜•</th>
                    <th>ìš”ì²­ ìƒí’ˆ</th>
                    <th>êµ¬ë§¤ì / íŒë§¤ì</th>
                    <th>ì£¼ë¬¸ ê¸ˆì•¡</th>
                    <th>ì²˜ë¦¬ ìƒíƒœ</th>
                    <th>ì£¼ë¬¸ ìƒíƒœ</th>
                    <th>ì²˜ë¦¬ ì•¡ì…˜</th>
                </tr>
            </thead>
            <tbody>
                {% for dispute in disputes %}
                <tr data-dispute-id="{{ dispute.dispute_id }}">
                    <td>{{ dispute.dispute_id }}</td>
                    <td><span class="issue-type issue-{{ dispute.issue_type }}">{{ dispute.issue_type }}</span></td>
                    <td>{{ dispute.product_name }}</td>
                    <td>{{ dispute.buyer_name }} / {{ dispute.seller_name }}</td>
                    <td>{{ dispute.total_price | number_format }}ì›</td>
                    
                    <td><span class="dispute-status status-{{ dispute.status | lower }}">{{ dispute.status }}</span></td>
                    <td>{{ dispute.order_status }}</td>
                    
                    <td class="action-cell">
                        {% if dispute.status == 'ì²˜ë¦¬ ì „' %}
                        <button class="btn admin-action-btn btn-processing" data-action="processing" onclick="updateDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì¤‘', null)">
                            ì²˜ë¦¬ ì‹œì‘
                        </button>
                        {% elif dispute.status == 'ì²˜ë¦¬ ì¤‘' %}
                            <div class="dispute-resolve-group">
                                <button class="btn admin-action-btn btn-refund" onclick="updateDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì™„ë£Œ', 'í™˜ë¶ˆ')">
                                    í™˜ë¶ˆ ìŠ¹ì¸
                                </button>
                                <button class="btn admin-action-btn btn-exchange" onclick="updateDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì™„ë£Œ', 'êµí™˜')">
                                    êµí™˜ ìŠ¹ì¸
                                </button>
                                <button class="btn admin-action-btn btn-reject" onclick="updateDisputeStatus({{ dispute.dispute_id }}, 'ì²˜ë¦¬ ì™„ë£Œ', 'ê±°ì ˆ')">
                                    ê±°ì ˆ (ì¢…ë£Œ)
                                </button>
                            </div>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div id="dispute-message" style="margin-top: 20px; font-weight: bold; text-align: center;"></div>
    </div>
<script>
    function updateDisputeStatus(disputeId, newStatus, resolution) {
        if (!confirm(`ë¶„ìŸ #${disputeId}ì˜ ìƒíƒœë¥¼ '${newStatus}'ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        const messageDiv = document.getElementById('dispute-message');
        const data = {
            dispute_id: disputeId,
            new_status: newStatus,
            resolution: resolution
        };

        messageDiv.textContent = 'ì²˜ë¦¬ ì¤‘...';

        fetch('/api/dispute/update_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.new_status) {
                messageDiv.textContent = result.message;
                messageDiv.style.color = '#4caf50'; // ì„±ê³µ ìƒ‰ìƒ

                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒíƒœ ë° ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    window.location.reload();
                }, 500);

            } else {
                messageDiv.textContent = result.error || result.message;
                messageDiv.style.color = '#e74c3c'; // ì˜¤ë¥˜ ìƒ‰ìƒ
            }
        })
        .catch(error => {
            messageDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬ ì‹¤íŒ¨';
            messageDiv.style.color = '#e74c3c';
        });
    }
</script>
{% endblock %}